<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin ‚Äî Complete Match Results & Payout</title>
<style>
:root{--bg:#0b0b0b;--card:#111;--accent:#00d5ff;--muted:#9aa;--ok:#4ade80;}
body{font-family:Inter, Poppins, system-ui, sans-serif;background:var(--bg);color:#fff;padding:18px;}
h1{color:var(--accent);text-align:center;margin-bottom:18px;}
.wrap{max-width:1100px;margin:0 auto;}
.match{background:var(--card);padding:14px;border-radius:10px;margin-bottom:18px;border:1px solid rgba(0,213,255,0.08);}
.meta{display:flex;gap:12px;align-items:center;margin-bottom:12px;}
.meta b{color:var(--accent);}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left;font-size:14px}
th{color:var(--accent)}
.thumb{width:72px;height:64px;object-fit:cover;border-radius:6px;cursor:pointer;border:1px solid rgba(0,213,255,0.08)}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.btn{background:var(--accent);color:#000;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
.btn:disabled{opacity:.6;cursor:not-allowed}
.btn-danger{background:#ff5b5b;color:#fff}
.small{font-size:13px;color:var(--muted)}
.resultPreview{background:#0f1720;padding:10px;border-radius:8px;margin-top:10px;border:1px solid rgba(255,255,255,0.03)}
.inputKills{width:80px;padding:6px;border-radius:6px;border:1px solid #222;background:#0b0b0b;color:#fff}
.info{color:var(--muted);font-size:13px}
.loading{color:var(--accent);text-align:center;margin:14px 0}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);align-items:center;justify-content:center;z-index:9999}
.modal img{max-width:90%;max-height:90%;border-radius:8px;border:4px solid var(--accent)}
.closeX{position:absolute;top:18px;right:22px;color:var(--accent);font-size:28px;cursor:pointer}
.highlight { outline: 2px solid rgba(0,234,255,.12); }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Admin ‚Äî Complete Match Results & Payout</h1>

    <div id="error" class="info" style="display:none;margin-bottom:12px"></div>
    <div id="loading" class="loading">Loading matches...</div>

    <div id="matches"></div>

    <div style="margin-top:24px;text-align:center;">
      <button class="btn btn-danger" onclick="localStorage.removeItem('token'); alert('Admin token cleared. Please login again.');">Clear token</button>
    </div>
  </div>

  <div class="modal" id="modal">
    <span class="closeX" onclick="closeModal()">√ó</span>
    <img id="modalImg" src="" alt="screenshot">
  </div>

<script>
/* ========== CONFIG ========== */
const API_BASE = "http://localhost:5000/api/wallet"; // adjust to your API
const token = localStorage.getItem("token") || "";   // ensure admin token is stored here

/* ========== HELPERS ========== */
function el(q){ return document.querySelector(q); }
function elAll(q){ return Array.from(document.querySelectorAll(q)); }
function showError(msg){ const e = el("#error"); e.style.display = msg ? "block" : "none"; e.innerText = msg || ""; }
function showLoading(flag){ el("#loading").style.display = flag ? "block" : "none"; }
function openModal(src){ el("#modalImg").src = src; el("#modal").style.display = "flex"; }
function closeModal(){ el("#modal").style.display = "none"; }

/* ========== LOAD MATCHES ========== */
async function loadMatches(){
  showError("");
  if(!token){ showError("Admin token missing ‚Äî set localStorage token."); showLoading(false); return; }
  showLoading(true);
  try {
    const r = await fetch(`${API_BASE}/admin/match/results`, {
      method: "GET",
      headers: { "Authorization": "Bearer " + token }
    });
    const data = await r.json();
    if (!data.success) {
      showError(data.msg || "Failed loading");
      el("#matches").innerHTML = "";
    } else {
      renderMatches(data.list || []);
    }
  } catch (err) {
    console.error(err);
    showError("Network error while loading matches");
    el("#matches").innerHTML = "";
  } finally {
    showLoading(false);
  }
}

/* ========== RENDER ========== */
function renderMatches(list){
  if (!list.length) {
    el("#matches").innerHTML = `<div class='info'>No match results available.</div>`;
    return;
  }

  const boardGameNames = ["ludo","carrom","8 ball pool","cricket"];

  const out = list.map(match => {
    const prizeSystem = match.prizeSystem || "team_equal";
    const players = (match.results || match.data || match.players || []).map(p => ({
      userId: (p.userId && (p.userId._id || p.userId)) || p.userId || p.id || p._id || "",
      name: p.name || (p.userId && p.userId.name) || "-",
      uid: p.uid || (p.userId && p.userId.uid) || "-",
      team: p.team || "-",
      kills: Number(p.kills || (p.kills === 0 ? 0 : (p.kills || 0))),
      screenshotUrl: p.screenshotUrl || ""
    }));

    const hideKills = boardGameNames.includes((match.game || "").toLowerCase());

    const rowsHtml = players.map(p => `
      <tr data-userid="${p.userId}">
        <td style="width:36px"><input type="radio" name="winner_${match._id}" class="teamRadio"></td>
        <td>${escapeHtml(p.name)}<br><small class="small">${escapeHtml(p.uid)}</small></td>
        <td>${escapeHtml(p.team)}</td>
        <td>${hideKills ? '-' : `<input class="inputKills" type="number" value="${p.kills}" data-user="${p.userId}">`}</td>
        <td>${p.screenshotUrl ? `<img class='thumb' src='${p.screenshotUrl}' onclick="openModal('${p.screenshotUrl}')">` : `<span class='small'>No screenshot</span>`}</td>
      </tr>
    `).join("");

    return `
      <div class="match" id="match_${match._id}">
        <div class="meta">
          <div>
            <b>Match #${match.matchNumber || match._id}</b>
            <div class="small">${escapeHtml(match.game || "Unknown")} ‚Ä¢ ${escapeHtml(match.mode || "-")} ‚Ä¢ ${escapeHtml(match.type || "-")}</div>
          </div>
          <div style="margin-left:auto" class="small">Entry Fee: ‚Çπ${match.entryFee || 0} ‚Ä¢ Players: ${players.length} ‚Ä¢ Prize System: ${escapeHtml(prizeSystem)}</div>
        </div>

        <table>
          <thead>
            <tr><th>Select</th><th>Player</th><th>Team</th><th>Kills</th><th>Screenshot</th></tr>
          </thead>
          <tbody>
            ${rowsHtml}
          </tbody>
        </table>

        <div class="controls">
          <div class="flex-row"><label class="small">Select winner player (admin)</label></div>
          <div style="margin-left:auto" class="flex-row">
            <button class="btn" onclick="previewPayout('${match._id}', ${Number(match.entryFee||0)})">Preview Payout</button>
            <button class="btn btn-winner" onclick="submitComplete('${match._id}', ${Number(match.entryFee||0)})">Complete Match</button>
            <button class="btn btn-danger" onclick="deleteMatch('${match._id}')">Delete Match</button>
          </div>
        </div>

        <!-- Preview container (must exist to avoid null error) -->
        <div id="preview_payout_${match._id}" class="resultPreview" style="display:none"></div>
      </div>
    `;
  });

  el("#matches").innerHTML = out.join("");
}

/* simple escaper for names/UIDs */
function escapeHtml(str) {
  if (str === null || str === undefined) return "";
  return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}

/* ========== PREVIEW PAYOUT ========== */
/* PREVIEW PAYOUT */
function previewPayout(matchId, entryFee) {
  const matchEl = document.querySelector(`#match_${matchId}`);
  if (!matchEl) return alert("Match not found in DOM");

  const rows = [...matchEl.querySelectorAll("tbody tr")];
  const selected = matchEl.querySelector("input[type=radio]:checked");
  if (!selected) return alert("Please select a winner first (radio).");

  const winnerRow = selected.closest("tr");
  const winnerId = winnerRow?.dataset?.userid;
  const winnerName = winnerRow?.children[1]?.innerText?.split("\n")[0].trim() || "Winner";

  const totalPlayers = rows.length;
  const totalCollected = Number(entryFee) * totalPlayers;
  const adminCut = Math.round(totalCollected * 0.08);
  const prizePool = Math.max(0, totalCollected - adminCut);

  const previewBox = document.querySelector(`#preview_payout_${matchId}`);
  if (!previewBox) return alert("Preview container missing");

  previewBox.style.display = "block";
  previewBox.innerHTML = `
    <div style="padding:10px;background:#111;border-radius:8px">
      <div><strong>Admin Selected Winner:</strong> ${escapeHtml(winnerName)}</div>
      <div style="color:#9aa;font-size:13px">Winner UID: <strong>${escapeHtml(winnerId)}</strong></div>
      <div style="margin-top:8px">Total players: ${totalPlayers}</div>
      <div>Total collected: ‚Çπ${totalCollected}</div>
      <div>Admin cut (8%): ‚Çπ${adminCut}</div>
      <hr style="border-color:#333;margin:8px 0">
      <div style="font-size:16px"><strong>Winner receives: ‚Çπ${prizePool}</strong></div>
    </div>
  `;
  previewBox.scrollIntoView({ behavior: "smooth", block: "center" });
}

/* SUBMIT COMPLETE */
async function submitComplete(matchId, entryFee) {
  const matchEl = document.querySelector(`#match_${matchId}`);
  if (!matchEl) return alert("Match not found");

  const selected = matchEl.querySelector("input[type=radio]:checked");
  if (!selected) return alert("Please select a winner (radio).");

  const winnerId = selected.closest("tr")?.dataset?.userid;
  if (!winnerId) return alert("Winner user id not found");

  // Prepare kills array for backend compatibility (board games can be 0)
  const rows = [...matchEl.querySelectorAll("tbody tr")];
  const gameText = (matchEl.querySelector(".meta .small")?.innerText || "").toLowerCase();
  const ignoreKills = ["ludo","carrom","8 ball pool","cricket"].some(g => gameText.includes(g));

  const kills = rows.map(r => {
    const uid = r.dataset.userid;
    const inp = r.querySelector("input.inputKills");
    if (ignoreKills) return { userId: uid, kills: 0 };
    if (inp) return { userId: uid, kills: Number(inp.value || 0) };
    return { userId: uid, kills: uid === winnerId ? 1 : 0 };
  });

  if (!confirm("Are you sure you want to complete this match and pay the admin-selected winner?")) return;

  try {
    // show loading if you have
    const res = await fetch(`${API_BASE}/admin/match/complete`, {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
      body: JSON.stringify({
        matchId,
        winnerTeam: winnerId,
        kills,
        prizeSystem: "" // optional
      })
    });
    const data = await res.json();
    if (!data.success) {
      alert(data.msg || "Server error");
      console.error("complete error:", data);
      return;
    }
    alert("Match completed; payout issued to admin-selected winner.");
    // reload list to refresh UI/history
    loadMatches();
  } catch (err) {
    console.error(err);
    alert("Network error while completing match");
  } finally {
    // hide loading if you have
  }
}

/* ========== SUBMIT COMPLETE ========== */
async function submitComplete(matchId, entryFee) {
  const matchEl = el(`#match_${matchId}`);
  if (!matchEl) return alert("Match not found");

  const selected = matchEl.querySelector("input[type=radio]:checked");
  if (!selected) return alert("Please select a winner (radio).");
  const winnerId = selected.closest("tr")?.dataset?.userid;
  if (!winnerId) return alert("Winner user id not found");

  // detect board games
  const gameText = (matchEl.querySelector(".meta .small")?.innerText || "").toLowerCase();
  const ignoreKills = ["ludo","carrom","8 ball pool","cricket"].some(g => gameText.includes(g));

  // prepare kills array for backend compatibility
  const rows = [...matchEl.querySelectorAll("tbody tr")];
  const kills = rows.map(r => {
    const uid = r.dataset.userid;
    if (ignoreKills) {
      return { userId: uid, kills: 0 };
    } else {
      // if input exists, use it; otherwise set 0 except winner -> 1 (to avoid kill-required)
      const inp = r.querySelector("input.inputKills");
      if (inp) return { userId: uid, kills: Number(inp.value || 0) };
      return { userId: uid, kills: uid === winnerId ? 1 : 0 };
    }
  });

  if (!confirm("Are you sure you want to complete this match and pay the admin-selected winner?")) return;

  try {
    showLoading(true);

    const res = await fetch(`${API_BASE}/admin/match/complete`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({
        matchId,
        winnerTeam: winnerId,
        kills,
        prizeSystem: "" // optional; backend may determine from match record
      })
    });

    const data = await res.json();
    if (!data.success) {
      alert(data.msg || "Server responded with failure");
      console.error("complete response:", data);
    } else {
      alert("Match completed and payout issued to admin-selected winner üëç");
      // optional: show payout details from response
      loadMatches();
    }
  } catch (err) {
    console.error(err);
    alert("Network error while completing match");
  } finally {
    showLoading(false);
  }
}

/* ========== DELETE MATCH ========== */
async function deleteMatch(matchId) {
  if (!confirm("Permanently delete this match? This cannot be undone.")) return;
  try {
    showLoading(true);
    const res = await fetch(`${API_BASE}/admin/match/${matchId}`, {
      method: "DELETE",
      headers: { "Authorization": "Bearer " + token }
    });
    const data = await res.json();
    if (!data.success) alert(data.msg || "Failed to delete");
    else { alert("Deleted"); loadMatches(); }
  } catch (err) {
    console.error(err);
    alert("Network error while deleting");
  } finally { showLoading(false); }
}

/* ========== INIT ========== */
loadMatches();
</script>
</body>
</html>





router.post("/admin/match/complete", authAdmin, async (req, res) => {
  try {
    const { matchId, winnerTeam /* winnerTeam = admin-selected userId */, kills = [], prizeSystem } = req.body;
    if (!matchId) return res.json({ success: false, msg: "Missing matchId" });
    if (!winnerTeam) return res.json({ success: false, msg: "Select winner (winnerTeam) first" });

    const match = await QuickMatch.findById(matchId).populate("players.userId", "name phone uid");
    if (!match) return res.json({ success: false, msg: "Match not found" });

    const entryFee = Number(match.entryFee) || 0;
    const players = Array.isArray(match.players) ? match.players : [];
    const numPlayers = players.length || 1;
    const totalCollected = entryFee * numPlayers;
    const adminCut = Math.round(totalCollected * 0.08);
    const prizePool = Math.max(0, totalCollected - adminCut);

    const ensureWallet = async (userId) => {
      let w = await Wallet.findOne({ userId });
      if (!w) w = await Wallet.create({ userId, balance: 0 });
      return w;
    };

    // find winner player object in match.players
    const winnerPlayer = players.find(p => String(p.userId._id || p.userId) === String(winnerTeam) || String(p.userId) === String(winnerTeam));
    if (!winnerPlayer) return res.json({ success: false, msg: "Selected winner not found in match" });

    // --- credit winner wallet ---
    await ensureWallet(winnerTeam);
    await Wallet.updateOne({ userId: winnerTeam }, { $inc: { balance: prizePool } });

    // --- transaction record ---
    await Transaction.create({
      userId: winnerTeam,
      matchId,
      type: "MATCH_REWARD",
      amount: prizePool,
      description: `Admin-selected winner reward for ${match.game}`,
      sign: "+",
      uiColor: "green"
    });

    // --- Build/Update userResults so UI/history can read consistent source ---
    // Normalize incoming kills map for convenience
    const killsMap = (Array.isArray(kills) ? kills : []).reduce((acc, k) => {
      if (!k) return acc;
      acc[String(k.userId)] = Number(k.kills || 0);
      return acc;
    }, {});

    // Compose userResults where each entry includes result and prize
    const userResults = players.map(p => {
      const uid = String(p.userId._id || p.userId);
      const isWinner = uid === String(winnerTeam);
      const prize = isWinner ? prizePool : 0;
      const killsValue = typeof killsMap[uid] !== "undefined" ? killsMap[uid] : (p.kills || 0);

      return {
        userId: uid,
        kills: killsValue,
        prize,
        result: isWinner ? "win" : "loss"
      };
    });

    // Save to match: winnerIds, prizeGiven, userResults, status
    match.status = "completed";
    match.winnerTeam = "ADMIN_SELECTED";
    match.winnerIds = [String(winnerTeam)];
    match.prizeGiven = prizePool;
    match.userResults = userResults;
    await match.save();

    return res.json({
      success: true,
      msg: "Match completed: payout issued to admin-selected winner",
      prizePool,
      payouts: userResults.filter(u => u.prize > 0)
    });

  } catch (err) {
    console.error("complete match error:", err);
    res.status(500).json({ success: false, msg: "Server Error", error: err.message });
  }
});

router.post("/admin/match/complete", authAdmin, async (req, res) => {
  try {
    const { matchId, winnerTeam } = req.body;
    if (!matchId) return res.json({ success: false, msg: "Missing matchId" });
    if (!winnerTeam) return res.json({ success: false, msg: "Select winner first" });

    const match = await QuickMatch.findById(matchId)
      .populate("players.userId", "name phone uid");

    if (!match) return res.json({ success: false, msg: "Match not found" });

    const entryFee = Number(match.entryFee) || 0;
    const numPlayers = match.players.length;
    const totalCollected = entryFee * numPlayers;
    const adminCut = Math.round(totalCollected * 0.08);
    const prizePool = totalCollected - adminCut;

    const ensureWallet = async (userId) => {
      let w = await Wallet.findOne({ userId });
      if (!w) w = await Wallet.create({ userId, balance: 0 });
      return w;
    };

    // ---- Find admin-selected winner ----
    const winnerPlayer = match.players.find(
      p => String(p.userId._id || p.userId) === winnerTeam
    );
    if (!winnerPlayer)
      return res.json({ success: false, msg: "Winner not found" });

    // ---- Wallet credit ----
    await ensureWallet(winnerTeam);
    await Wallet.updateOne(
      { userId: winnerTeam },
      { $inc: { balance: prizePool } }
    );

    // ---- Transaction record ----
    await Transaction.create({
      userId: winnerTeam,
      matchId,
      type: "MATCH_REWARD",
      amount: prizePool,
      description: "Admin-Selected Winner Reward"
    });

    // ---- Update match ----
    match.status = "completed";
    match.winnerTeam = "ADMIN_SELECTED";
    match.winnerIds = [winnerTeam];
    match.prizeGiven = prizePool;
    await match.save();

    return res.json({
      success: true,
      msg: "Match completed",
      prizePool,
      payouts: [{ userId: winnerTeam, share: prizePool }]
    });

  } catch (err) {
    console.error("complete match error:", err);
    res.status(500).json({ success: false, msg: "Server Error" });
  }
});

router.post("/admin/match/complete", authAdmin, async (req, res) => {
  try {
    const { matchId, winnerTeam, kills = [], prizeSystem } = req.body;
    if (!matchId) return res.json({ success: false, msg: "Missing matchId" });

    const match = await QuickMatch.findById(matchId).populate("players.userId", "name phone uid");
    if (!match) return res.json({ success: false, msg: "Match not found" });

    const entryFee = Number(match.entryFee) || 0;
    const numPlayers = Array.isArray(match.players) ? match.players.length : 1;
    const totalCollected = entryFee * numPlayers;
    const adminCut = Math.round((totalCollected * 8) / 100);
    const prizePool = Math.max(0, totalCollected - adminCut);

    const boardGames = ["ludo", "carrom", "8 ball pool", "cricket"];
    const isBoardGame = boardGames.includes(match.game.toLowerCase());

    const ensureWallet = async (userId) => {
      let w = await Wallet.findOne({ userId });
      if (!w) w = await Wallet.create({ userId, balance: 0 });
      return w;
    };

    // --------------------------
    // 1v1 MATCH
    // --------------------------
    if (match.type === "1v1") {
      let winnerId;
      if (winnerTeam) {
        winnerId = winnerTeam; // Admin selected
      } else {
        if (!kills.length) return res.json({ success: false, msg: "Kills required" });
        const sorted = [...kills].sort((a, b) => b.kills - a.kills);
        winnerId = sorted[0].userId;
      }

      await ensureWallet(winnerId);
      await Wallet.updateOne({ userId: winnerId }, { $inc: { balance: prizePool } });

      await Transaction.create({
        userId: winnerId,
        matchId,
        type: "MATCH_REWARD",
        amount: prizePool,
        description: "1v1 Winner"
      });

      match.status = "completed";
      match.winnerTeam = "SOLO";
      match.winnerIds = [winnerId];
      match.prizeGiven = prizePool;
      await match.save();

      return res.json({ success: true, msg: "1v1 match completed", prizePool });
    }

    // --------------------------
    // TEAM / BOARD GAME MATCH
    // --------------------------
    if (!winnerTeam) return res.json({ success: false, msg: "winnerTeam required" });

    const playersWithTeams = match.players.map((p, idx) => ({
      ...p.toObject(),
      team: p.team || (match.prizeSystem === "team_equal" ? (idx < Math.ceil(match.players.length/2) ? "LION" : "TIGER") : "UNKNOWN")
    }));

    // If board game, only admin-selected winner gets full prize
    let payouts = [];
    if (isBoardGame) {
      const winner = playersWithTeams.find(p => String(p.userId._id || p.userId) === winnerTeam);
      if (!winner) return res.json({ success: false, msg: "Admin-selected winner not found" });

      await ensureWallet(winner.userId);
      await Wallet.updateOne({ userId: winner.userId }, { $inc: { balance: prizePool } });

      payouts.push({
        userId: winner.userId,
        kills: 0,
        share: prizePool
      });

      await Transaction.create({
        userId: winner.userId,
        matchId,
        type: "MATCH_REWARD",
        amount: prizePool,
        description: "Admin Selected Winner"
      });
    } else {
      // Original logic for kill-based or team-equal
      const winners = playersWithTeams.filter(p => p.team === winnerTeam);
      if (!winners.length) return res.json({ success: false, msg: "Winner team has no players" });

      const winnerKills = winners.map(p => {
        const uid = String(p.userId._id || p.userId);
        const found = kills.find(k => k.userId === uid);
        return { userId: uid, kills: found ? found.kills : 0 };
      });

      if (prizeSystem === "team_equal") {
        const share = Math.round(prizePool / winnerKills.length);
        for (let w of winnerKills) {
          await ensureWallet(w.userId);
          await Wallet.updateOne({ userId: w.userId }, { $inc: { balance: share } });
          payouts.push({ userId: w.userId, kills: w.kills, share });
          await Transaction.create({
            userId: w.userId,
            matchId,
            type: "MATCH_REWARD",
            amount: share,
            description: "Team Equal Reward"
          });
        }
      } else if (prizeSystem === "kill_based") {
        const totalKills = winnerKills.reduce((n, k) => n + k.kills, 0);
        for (let w of winnerKills) {
          const share = totalKills > 0
            ? Math.round((w.kills / totalKills) * prizePool)
            : Math.round(prizePool / winnerKills.length);

          await ensureWallet(w.userId);
          await Wallet.updateOne({ userId: w.userId }, { $inc: { balance: share } });

          payouts.push({ userId: w.userId, kills: w.kills, share });
          await Transaction.create({
            userId: w.userId,
            matchId,
            type: "MATCH_REWARD",
            amount: share,
            description: "Kill Based Reward"
          });
        }
      }
    }

    match.status = "completed";
    match.winnerTeam = winnerTeam;
    match.winnerIds = payouts.map(p => p.userId);
    match.prizeGiven = prizePool;
    await match.save();

    res.json({ success: true, msg: "Match completed", prizePool, payouts });

  } catch (err) {
    console.error("complete match error:", err);
    res.status(500).json({ success: false, msg: "Server Error" });
  }
});

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin ‚Äî Complete Match Results & Payout</title>
<style>
  :root{--bg:#0b0b0b;--card:#111;--accent:#00d5ff;--muted:#9aa;--success:#28c76f;}
  body{font-family:Inter, Poppins, system-ui, sans-serif;background:var(--bg);color:#fff;padding:18px;}
  h1{color:var(--accent);text-align:center;margin-bottom:18px;}
  .wrap{max-width:1100px;margin:0 auto;}
  .match{background:var(--card);padding:14px;border-radius:10px;margin-bottom:18px;border:1px solid rgba(0,213,255,0.08);}
  .meta{display:flex;gap:12px;align-items:center;margin-bottom:12px;}
  .meta b{color:var(--accent);}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left;font-size:14px}
  th{color:var(--accent)}
  .thumb{width:72px;height:64px;object-fit:cover;border-radius:6px;cursor:pointer;border:1px solid rgba(0,213,255,0.08)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .btn{background:var(--accent);color:#000;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn-danger{background:#ff5b5b;color:#fff}
  .teamRadio{margin-right:10px}
  .calcBox{margin-left:auto;text-align:right}
  .small{font-size:13px;color:var(--muted)}
  .resultPreview{background:#0f1720;padding:10px;border-radius:8px;margin-top:10px;border:1px solid rgba(255,255,255,0.03)}
  .flex-row{display:flex;gap:8px;align-items:center}
  .inputKills{width:70px;padding:6px;border-radius:6px;border:1px solid #222;background:#0b0b0b;color:#fff}
  .info{color:var(--muted);font-size:13px}
  .loading{color:var(--accent);text-align:center;margin:14px 0}
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);align-items:center;justify-content:center;z-index:9999}
  .modal img{max-width:90%;max-height:90%;border-radius:8px;border:4px solid var(--accent)}
  .closeX{position:absolute;top:18px;right:22px;color:var(--accent);font-size:28px;cursor:pointer}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Admin ‚Äî Complete Match Results & Payout</h1>

    <div id="error" class="info" style="display:none;margin-bottom:12px"></div>
    <div id="loading" class="loading">Loading matches...</div>

    <div id="matches"></div>

    <div style="margin-top:24px;text-align:center;">
      <button class="btn btn-danger" onclick="localStorage.removeItem('adminToken'); alert('Admin token cleared. Please login again.');">Clear adminToken</button>
    </div>
  </div>

  <div class="modal" id="modal">
    <span class="closeX" onclick="closeModal()">√ó</span>
    <img id="modalImg" src="" alt="screenshot">
  </div>

<script>
const API_BASE = "http://localhost:5000/api/wallet";
const token = localStorage.getItem("token") || "";

function el(q){return document.querySelector(q)}
function elAll(q){return Array.from(document.querySelectorAll(q))}

function showError(msg){ const e = el("#error"); e.style.display = msg?"block":"none"; e.innerText = msg||""; }
function showLoading(flag){ el("#loading").style.display = flag?"block":"none"; }
function openModal(src){ el("#modalImg").src = src; el("#modal").style.display = "flex"; }
function closeModal(){ el("#modal").style.display = "none"; }

async function loadMatches(){
  showError("");
  if(!token){ showError("Admin token missing."); showLoading(false); return; }
  showLoading(true);
  try{
    const r = await fetch(`${API_BASE}/admin/match/results`,{
      method:"GET",
      headers:{ "Authorization":"Bearer "+token, "Content-Type":"application/json" }
    });
    const data = await r.json();
    if(!data.success){ showError(data.msg||"Failed loading"); el("#matches").innerHTML=""; return; }
    renderMatches(data.list||[]);
  }catch(err){ showError("Network error"); }
  finally{ showLoading(false); }
}

function renderMatches(list){
  if(!list.length){ el("#matches").innerHTML = `<div class='info'>No match results available.</div>`; return; }
  const out = [];
  list.forEach(match=>{
    const prizeSystem = match.prizeSystem || "team_equal";
    const players = (match.results || match.data || []).map(p=>({
      userId:p.userId,
      name:p.name||"-",
      uid:p.uid||"-",
      team:p.team||"-",
      kills:Number(p.kills)||0,
      screenshotUrl:p.screenshotUrl||"",
      uploadedAt:p.uploadedAt||p.createdAt||null
    }));

    const playersHtml = players.map(p=>`
      <tr data-userid="${p.userId}">
        <td><input type="radio" name="team_${match._id}" class="teamRadio" data-team="${p.team}"></td>
        <td>${p.name}<br><small class="small">${p.uid}</small></td>
       
        <td>${p.team}</td>
        <td><input class="inputKills" type="number" value="${p.kills}" data-user="${p.userId}"></td>
        <td>${p.screenshotUrl?`<img class='thumb' src='${p.screenshotUrl}' onclick="openModal('${p.screenshotUrl}')">`:`<span class='small'>No screenshot</span>`}</td>
        <td class="small">${p.uploadedAt?new Date(p.uploadedAt).toLocaleString():"-"}</td>
      </tr>`).join("");

    out.push(`
      <div class="match" id="match_${match._id}">
        <div class="meta">
          <div>
            <b>Match #${match.matchNumber}</b>
            <div class="small">${match.game} ‚Ä¢ ${match.mode} ‚Ä¢ ${match.type}</div>
          </div>
          <div class="small">Entry Fee: ‚Çπ${match.entryFee} ‚Ä¢ Players: ${players.length} ‚Ä¢ Prize System: ${prizeSystem}</div>
        </div>

        <table><thead><tr>
          <th>Select</th><th>Player</th><th>Team</th><th>Kills</th><th>Screenshot</th><th>Uploaded</th>
        </tr></thead><tbody>${playersHtml}</tbody></table>

        <div class="controls">
          <div class="flex-row"><label class="small">Select winner team</label></div>
          <div style="margin-left:auto" class="flex-row">
            <button class="btn" onclick="previewPayout('${match._id}', ${match.entryFee}, '${match.type}', '${prizeSystem}')">Preview Payout</button>
            <button class="btn btn-winner" onclick="submitComplete('${match._id}', '${match.type}', ${match.entryFee}, '${prizeSystem}')">Complete Match</button>
            <button class="btn btn-danger" onclick="deleteMatch('${match._id}')">Delete Match</button>
          </div>
        </div>

        <div id="preview_${match._id}" class="resultPreview" style="display:none"></div>
      </div>
    `);
  });

  el("#matches").innerHTML = out.join("");
}

function previewPayout(matchId, entryFee, matchType, prizeSystem){
  const table = el(`#match_${matchId} table`);
  const rows = [...table.querySelectorAll("tbody tr")];
  const players = rows.map(r=>({
    userId:r.querySelector("input.inputKills").dataset.user,
    kills:Number(r.querySelector("input.inputKills").value)||0,
    team:r.children[2].innerText.trim(),
    name:r.children[1].innerText.split("\n")[0].trim()
  }));

  const totalCollected = players.length * Number(entryFee);
  const adminCut = totalCollected * 0.08;
  const prizePool = totalCollected - adminCut;

  if(matchType === "1v1"){
    const winner = players.sort((a,b)=>b.kills-a.kills)[0];
    el(`#preview_${matchId}`).style.display="block";
    el(`#preview_${matchId}`).innerHTML = `Winner: ${winner.name} ‚Äî Payout: ‚Çπ${prizePool.toFixed(2)}`;
    return;
  }

  const radio = el(`#match_${matchId} input[type=radio]:checked`);
  if(!radio){ alert("Select winner team first"); return; }

  const winnerTeam = radio.dataset.team;
  const winnerPlayers = players.filter(p=>p.team===winnerTeam);

  let payouts = [];

  if(prizeSystem === "team_equal"){
    const share = prizePool / winnerPlayers.length;
    payouts = players.map(p=>({...p, share: p.team===winnerTeam?share:0}));
  } else {
    const totalKills = winnerPlayers.reduce((s,p)=>s+p.kills,0);
    payouts = players.map(p=>{
      if(p.team!==winnerTeam) return {...p,share:0};
      const share = totalKills? (p.kills/totalKills)*prizePool : prizePool/winnerPlayers.length;
      return {...p,share};
    });
  }

  let html = `<b>Winning Team:</b> ${winnerTeam}<br><br>`;
  html += `<table style='width:100%'><tr><th>Player</th><th>Kills</th><th>Share (‚Çπ)</th></tr>`;
  payouts.forEach(p=> html += `<tr><td>${p.name}</td><td>${p.kills}</td><td>${p.share.toFixed(2)}</td></tr>`);
  html += `</table>`;

  const box = el(`#preview_${matchId}`);
  box.style.display="block";
  box.innerHTML = html;
}

async function submitComplete(matchId, matchType, entryFee, prizeSystem) {
  const table = document.querySelector(`#match_${matchId} table`);
  if(!table) return alert("No players table found");

  const rows = [...table.querySelectorAll("tbody tr")];
  const kills = rows.map(r => ({
    userId: r.querySelector("input.inputKills")?.dataset.user,
    kills: Number(r.querySelector("input.inputKills")?.value || 0)
  }));

  let winnerTeam = null;
  if (matchType !== "1v1") {
    const radio = document.querySelector(`#match_${matchId} input[type=radio]:checked`);
    if (!radio) return alert("Please select a Winner Team");
    winnerTeam = radio.dataset.team;
  }

  if (!confirm(`Are you sure to complete this match?\nPrize System: ${prizeSystem}`)) return;

  try {
    showLoading(true);
    const response = await fetch(`${API_BASE}/admin/match/complete`, {
      method: "POST",
      headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" },
      body: JSON.stringify({ matchId, winnerTeam, kills, prizeSystem })
    });
    const data = await response.json();
    if (!data.success) alert(data.msg || "Reward failed");
    else {
      alert("Match Completed Successfully");
      loadMatches();
    }
  } catch (err) {
    console.error(err);
    alert("Network error");
  } finally { showLoading(false); }
}

async function deleteMatch(matchId){
  if(!confirm("Are you sure you want to permanently delete this match? This cannot be undone.")) return;

  try {
    showLoading(true);
    const res = await fetch(`${API_BASE}/admin/match/${matchId}`, {
      method: "DELETE",
      headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" }
    });
    const data = await res.json();
    if(!data.success) alert(data.msg || "Failed to delete match");
    else {
      alert("Match deleted successfully");
      loadMatches();
    }
  } catch(err){
    console.error(err);
    alert("Network error while deleting match");
  } finally { showLoading(false); }
}

loadMatches();
</script>
</body>
</html> 


<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin ‚Äî Complete Match Results & Payout</title>
<style>
  :root{--bg:#0b0b0b;--card:#111;--accent:#00d5ff;--muted:#9aa;--success:#28c76f;}
  body{font-family:Inter, Poppins, system-ui, sans-serif;background:var(--bg);color:#fff;padding:18px;}
  h1{color:var(--accent);text-align:center;margin-bottom:18px;}
  .wrap{max-width:1100px;margin:0 auto;}
  .match{background:var(--card);padding:14px;border-radius:10px;margin-bottom:18px;border:1px solid rgba(0,213,255,0.08);}
  .meta{display:flex;gap:12px;align-items:center;margin-bottom:12px;}
  .meta b{color:var(--accent);}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left;font-size:14px}
  th{color:var(--accent)}
  .thumb{width:72px;height:64px;object-fit:cover;border-radius:6px;cursor:pointer;border:1px solid rgba(0,213,255,0.08)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .btn{background:var(--accent);color:#000;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn-danger{background:#ff5b5b;color:#fff}
  .teamRadio{margin-right:10px}
  .calcBox{margin-left:auto;text-align:right}
  .small{font-size:13px;color:var(--muted)}
  .resultPreview{background:#0f1720;padding:10px;border-radius:8px;margin-top:10px;border:1px solid rgba(255,255,255,0.03)}
  .flex-row{display:flex;gap:8px;align-items:center}
  .inputKills{width:70px;padding:6px;border-radius:6px;border:1px solid #222;background:#0b0b0b;color:#fff}
  .info{color:var(--muted);font-size:13px}
  .loading{color:var(--accent);text-align:center;margin:14px 0}
  /* modal */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);align-items:center;justify-content:center;z-index:9999}
  .modal img{max-width:90%;max-height:90%;border-radius:8px;border:4px solid var(--accent)}
  .closeX{position:absolute;top:18px;right:22px;color:var(--accent);font-size:28px;cursor:pointer}
  pre{white-space:pre-wrap;word-break:break-word}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Admin ‚Äî Complete Match Results & Payout</h1>

    <div id="error" class="info" style="display:none;margin-bottom:12px"></div>
    <div id="loading" class="loading">Loading matches...</div>

    <div id="matches"></div>

    <div style="margin-top:24px;text-align:center;">
      <button class="btn btn-danger" onclick="localStorage.removeItem('adminToken'); alert('Admin token cleared. Please login again.');">Clear adminToken</button>
    </div>
  </div>

  <!-- screenshot modal -->
  <div class="modal" id="modal">
    <span class="closeX" onclick="closeModal()">√ó</span>
    <img id="modalImg" src="" alt="screenshot">
  </div>

<script>
/*
  WHAT THIS UI SENDS:
  POST /api/wallet/admin/match/complete
  body: { matchId, winnerTeam, kills }
  kills = [{ userId, kills }]
  Header: Authorization: Bearer <adminToken>
*/

// config
const API_BASE = "http://localhost:5000/api/wallet";
 const token = localStorage.getItem("token") || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4NWQ3MjNkYmE3YjJmY2Q2NDhlZWViYyIsInBob25lIjoiNzQxMjg1MDM1MyIsImlzQWRtaW4iOnRydWUsImlhdCI6MTc2MzE1OTE4MywiZXhwIjoxNzYzNzYzOTgzfQ.gp9Y0ofcHky8Fox7NtHrMd5GdmI4k4oY52x_27JskmA";


// helper
function el(q){return document.querySelector(q)}
function elAll(q){return Array.from(document.querySelectorAll(q))}

function showError(msg){
  const e = el("#error");
  e.style.display = msg ? "block" : "none";
  e.innerText = msg || "";
}
function showLoading(flag){
  el("#loading").style.display = flag ? "block" : "none";
}

// open screenshot
function openModal(src){
  el("#modalImg").src = src;
  el("#modal").style.display = "flex";
}
function closeModal(){ el("#modal").style.display = "none"; }

// fetch matches and render
async function loadMatches(){ showError(""); if(!token){ showError("Admin token missing. Save adminToken in localStorage after login."); showLoading(false); return; } showLoading(true);

  try {
    const r = await fetch(`${API_BASE}/admin/match/results`, {
      method: "GET",
      headers: {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      }
    });

    const data = await r.json();
    console.log("admin/match/results ->", data);

    if (!data.success) {
      showError(data.msg || "Failed to fetch matches");
      el("#matches").innerHTML = "";
      return;
    }

    renderMatches(data.list || []);
  } catch (err) {
    console.error(err);
    showError("Network error while loading matches");
  } finally {
    showLoading(false);
  }
}


// render UI per match
function renderMatches(list) {
  const out = [];
  if (!Array.isArray(list) || list.length === 0) {
    el("#matches").innerHTML = `<div class="info">No match results available.</div>`;
    return;
  }

  list.forEach(match => {
    const players = Array.isArray(match.results) ? match.results : (Array.isArray(match.data) ? match.data : []);

    const playersNormalized = players.map(p => ({
      userId: p.userId,
      name: p.name || "-",
      uid: p.uid || "-",
      team: p.team || "-",
      kills: Number(p.kills) || 0,
      screenshotUrl: p.screenshotUrl || "",
      
      uploadedAt: p.uploadedAt || p.createdAt || null
      
    }));

    const playersHtml = playersNormalized.map((p, idx) => `
      <tr data-userid="${p.userId}">
        <td style="width:48px">
          <input type="radio" name="team_${match._id}" class="teamRadio" data-team="${p.team}" 
                 title="Select this player's team as winner">
        </td>
        <td>${p.name}<br><small class="small">${p.uid}</small></td>
        <td>${p.team}</td>
        <td><input class="inputKills" type="number" min="0" value="${p.kills}" data-user="${p.userId}"></td>
        <td>${p.screenshotUrl ? `<img class="thumb" src="${p.screenshotUrl}" onclick="openModal('${p.screenshotUrl}')">` : '<span class="small">No screenshot</span>'}</td>
        <td class="small">${p.uploadedAt ? new Date(p.uploadedAt).toLocaleString() : "-"}</td>
        
      </tr>
    `).join("");

    const html = `
      <div class="match" id="match_${match._id}">
        <div class="meta">
          <div>
            <b>Match #${match.matchNumber}</b>
            <div class="small">${match.game} ‚Ä¢ ${match.mode} ‚Ä¢ ${match.type}</div>
          </div>
          <div class="small">
            Entry Fee: ‚Çπ${match.entryFee} ‚Ä¢ Players: ${match.totalPlayers || playersNormalized.length} ‚Ä¢ 
            Prize System: ${match.prizeSystem || "-"} <!-- ‚úÖ show match-level prizeSystem -->
          </div>
          <div class="calcBox small" id="calc_${match._id}" style="margin-left:auto">
            <div>Prize Pool: ‚Äî</div>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Select Winner Team</th>
              <th>Player</th>
              <th>Team</th>
              <th>Kills (editable)</th>
              <th>Screenshot</th>
              <th>Uploaded</th>
              
            </tr>
          </thead>
          <tbody>
            ${playersHtml}
          </tbody>
        </table>

        <div class="controls">
          <div class="flex-row">
            <label class="small">Choose winner team by selecting any player in that team (radio)</label>
          </div>

          <div style="margin-left:auto" class="flex-row">
            <button class="btn" onclick="previewPayout('${match._id}', ${match.entryFee}, '${match.type}')">Preview Payout</button>
            <button class="btn btn-winner" onclick="submitComplete('${match._id}', '${match.type}', ${match.entryFee})">Complete Match</button>
          </div>
        </div>

        <div id="preview_${match._id}" class="resultPreview" style="display:none"></div>
      </div>
    `;
    out.push(html);
  });

  el("#matches").innerHTML = out.join("");
}



/* calculate prize pool and per-player share and show preview
   For 1v1: prizePool -> winner gets full pool (admin cut 8%)
   For team matches: admin selects winning team using radio; use kills inputs to calculate share */
function previewPayout(matchId, entryFee, matchType, prizeSystem){
  const table = el(`#match_${matchId} table`);
  if(!table){ alert("Match element not found"); return; }

  const rows = Array.from(table.querySelectorAll("tbody tr"));
  const players = rows.map(r => {
    const userId = r.querySelector("input.inputKills").dataset.user;
    const kills = Number(r.querySelector("input.inputKills").value) || 0;
    const team = r.children[2].innerText.trim();
    const name = r.children[1].innerText.split("\n")[0].trim();
    return { userId, name, team, kills };
  });

  const totalPlayers = players.length;
  const totalCollected = totalPlayers * Number(entryFee || 0);
  const adminCut = (totalCollected * 8) / 100;
  const prizePool = totalCollected - adminCut;

  if(matchType === "1v1"){
    const winner = players.sort((a,b)=>b.kills-a.kills)[0];
    const preview = `
      <div><b>Total Collected:</b> ‚Çπ${totalCollected}</div>
      <div><b>Admin Cut (8%):</b> ‚Çπ${adminCut.toFixed(2)}</div>
      <div><b>Prize Pool:</b> ‚Çπ${prizePool.toFixed(2)}</div>
      <hr>
      <div><b>Winner (top kills):</b> ${winner.name} ‚Äî Kills: ${winner.kills} ‚Äî <b>Payout:</b> ‚Çπ${prizePool.toFixed(2)}</div>
    `;
    const box = el(`#preview_${matchId}`);
    box.style.display = "block";
    box.innerHTML = preview;
    return;
  }

  // team match
  const radio = el(`#match_${matchId} input[type="radio"]:checked`);
  if(!radio){ alert("Select winner team first"); return; }
  const winnerTeam = radio.dataset.team;
  const winnerPlayers = players.filter(p=>p.team===winnerTeam);

  let payoutsHtml = [];
  if(prizeSystem === "team_equal"){
    const share = prizePool / winnerPlayers.length;
    payoutsHtml = players.map(p=>{
      if(p.team !== winnerTeam) return {...p, share:0};
      return {...p, share};
    });
  } else if(prizeSystem === "kill_based"){
    const totalKills = winnerPlayers.reduce((s,p)=>s+(p.kills||0),0);
    payoutsHtml = players.map(p=>{
      if(p.team !== winnerTeam) return {...p, share:0};
      const share = totalKills > 0 ? (p.kills/totalKills)*prizePool : prizePool/winnerPlayers.length;
      return {...p, share};
    });
  }

  // build HTML
  let preview = `<div><b>Total Collected:</b> ‚Çπ${totalCollected}</div>
                 <div><b>Admin Cut (8%):</b> ‚Çπ${adminCut.toFixed(2)}</div>
                 <div><b>Prize Pool:</b> ‚Çπ${prizePool.toFixed(2)}</div>
                 <hr>
                 <div><b>Winning Team:</b> ${winnerTeam}</div>
                 <table style="width:100%;margin-top:8px;border-collapse:collapse">
                   <tr style="color:var(--accent)"><th>Player</th><th>Kills</th><th>Share (‚Çπ)</th></tr>`;
  payoutsHtml.forEach(p=>{
    preview += `<tr><td>${p.name}</td><td>${p.kills}</td><td>‚Çπ${(p.share||0).toFixed(2)}</td></tr>`;
  });
  preview += `</table>`;

  const box = el(`#preview_${matchId}`);
  box.style.display = "block";
  box.innerHTML = preview;
}

async function submitComplete(matchId, matchType, entryFee, prizeSystem){
  const table = el(`#match_${matchId} table`);
  const rows = Array.from(table.querySelectorAll("tbody tr"));
  const kills = rows.map(r=>({
    userId: r.querySelector("input.inputKills").dataset.user,
    kills: Number(r.querySelector("input.inputKills").value) || 0
  }));

  let winnerTeam = null;
  if(matchType !== "1v1"){
    const radio = el(`#match_${matchId} input[type="radio"]:checked`);
    if(!radio){ alert("Select winner team first"); return; }
    winnerTeam = radio.dataset.team;
  }

  if(!confirm("Complete match and distribute prizes?")) return;

  try{
    showLoading(true);
    const payload = { matchId, winnerTeam, kills, prizeSystem };

    const r = await fetch(`${API_BASE}/admin/match/complete`, {
      method:"POST",
      headers:{
        "Authorization":"Bearer "+token,
        "Content-Type":"application/json"
      },
      body: JSON.stringify(payload)
    });
    const data = await r.json();
    console.log("complete ->", data);
    if(!data.success) alert("Failed: "+(data.msg||"Server error"));
    else{
      alert("Success: "+(data.msg||"Match completed"));
      loadMatches();
    }
  } catch(err){
    console.error(err);
    alert("Network error while completing match");
  } finally{ showLoading(false); }
}


// initial loader
loadMatches();
</script>
</body>
</html> 






<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin ‚Äî Complete Match Results & Payout</title>
<style>
:root{--bg:#0b0b0b;--card:#111;--accent:#00d5ff;--muted:#9aa;--ok:#4ade80;}
body{font-family:Inter, Poppins, system-ui, sans-serif;background:var(--bg);color:#fff;padding:18px;}
h1{color:var(--accent);text-align:center;margin-bottom:18px;}
.wrap{max-width:1100px;margin:0 auto;}
.match{background:var(--card);padding:14px;border-radius:10px;margin-bottom:18px;border:1px solid rgba(0,213,255,0.08);}
.meta{display:flex;gap:12px;align-items:center;margin-bottom:12px;}
.meta b{color:var(--accent);}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left;font-size:14px}
th{color:var(--accent)}
.thumb{width:72px;height:64px;object-fit:cover;border-radius:6px;cursor:pointer;border:1px solid rgba(0,213,255,0.08)}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.btn{background:var(--accent);color:#000;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
.btn:disabled{opacity:.6;cursor:not-allowed}
.btn-danger{background:#ff5b5b;color:#fff}
.small{font-size:13px;color:var(--muted)}
.resultPreview{background:#0f1720;padding:10px;border-radius:8px;margin-top:10px;border:1px solid rgba(255,255,255,0.03)}
.inputKills{width:80px;padding:6px;border-radius:6px;border:1px solid #222;background:#0b0b0b;color:#fff}
.info{color:var(--muted);font-size:13px}
.loading{color:var(--accent);text-align:center;margin:14px 0}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);align-items:center;justify-content:center;z-index:9999}
.modal img{max-width:90%;max-height:90%;border-radius:8px;border:4px solid var(--accent)}
.closeX{position:absolute;top:18px;right:22px;color:var(--accent);font-size:28px;cursor:pointer}
.highlight { outline: 2px solid rgba(0,234,255,.12); }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Admin ‚Äî Complete Match Results & Payout</h1>

    <div id="error" class="info" style="display:none;margin-bottom:12px"></div>
    <div id="loading" class="loading">Loading matches...</div>

    <div id="matches"></div>

    <div style="margin-top:24px;text-align:center;">
      <button class="btn btn-danger" onclick="localStorage.removeItem('token'); alert('Admin token cleared. Please login again.');">Clear token</button>
    </div>
  </div>

  <div class="modal" id="modal">
    <span class="closeX" onclick="closeModal()">√ó</span>
    <img id="modalImg" src="" alt="screenshot">
  </div>

<script>
/* ========== CONFIG ========== */
const API_BASE = "http://localhost:5000/api/wallet"; // adjust to your API
const token = localStorage.getItem("token") || "";   // ensure admin token is stored here

/* ========== HELPERS ========== */
function el(q){ return document.querySelector(q); }
function elAll(q){ return Array.from(document.querySelectorAll(q)); }
function showError(msg){ const e = el("#error"); e.style.display = msg ? "block" : "none"; e.innerText = msg || ""; }
function showLoading(flag){ el("#loading").style.display = flag ? "block" : "none"; }
function openModal(src){ el("#modalImg").src = src; el("#modal").style.display = "flex"; }
function closeModal(){ el("#modal").style.display = "none"; }

/* ========== LOAD MATCHES ========== */
async function loadMatches(){
  showError("");
  if(!token){ showError("Admin token missing ‚Äî set localStorage token."); showLoading(false); return; }
  showLoading(true);
  try {
    const r = await fetch(`${API_BASE}/admin/match/results`, {
      method: "GET",
      headers: { "Authorization": "Bearer " + token }
    });
    const data = await r.json();
    if (!data.success) {
      showError(data.msg || "Failed loading");
      el("#matches").innerHTML = "";
    } else {
      renderMatches(data.list || []);
    }
  } catch (err) {
    console.error(err);
    showError("Network error while loading matches");
    el("#matches").innerHTML = "";
  } finally {
    showLoading(false);
  }
}

/* ========== RENDER ========== */
function renderMatches(list){
  if (!list.length) {
    el("#matches").innerHTML = `<div class='info'>No match results available.</div>`;
    return;
  }

  const boardGameNames = ["ludo","carrom","8 ball pool","cricket"];

  const out = list.map(match => {
    const prizeSystem = match.prizeSystem || "team_equal";
    const players = (match.results || match.data || match.players || []).map(p => ({
      userId: (p.userId && (p.userId._id || p.userId)) || p.userId || p.id || p._id || "",
      name: p.name || (p.userId && p.userId.name) || "-",
      uid: p.uid || (p.userId && p.userId.uid) || "-",
      team: p.team || "-",
      kills: Number(p.kills || (p.kills === 0 ? 0 : (p.kills || 0))),
      screenshotUrl: p.screenshotUrl || ""
    }));

    const hideKills = boardGameNames.includes((match.game || "").toLowerCase());

    const rowsHtml = players.map(p => `
      <tr data-userid="${p.userId}">
        <td style="width:36px"><input type="radio" name="winner_${match._id}" class="teamRadio"></td>
        <td>${escapeHtml(p.name)}<br><small class="small">${escapeHtml(p.uid)}</small></td>
        <td>${escapeHtml(p.team)}</td>
        <td>${hideKills ? '-' : `<input class="inputKills" type="number" value="${p.kills}" data-user="${p.userId}">`}</td>
        <td>${p.screenshotUrl ? `<img class='thumb' src='${p.screenshotUrl}' onclick="openModal('${p.screenshotUrl}')">` : `<span class='small'>No screenshot</span>`}</td>
      </tr>
    `).join("");

    return `
      <div class="match" id="match_${match._id}">
        <div class="meta">
          <div>
            <b>Match #${match.matchNumber || match._id}</b>
            <div class="small">${escapeHtml(match.game || "Unknown")} ‚Ä¢ ${escapeHtml(match.mode || "-")} ‚Ä¢ ${escapeHtml(match.type || "-")}</div>
          </div>
          <div style="margin-left:auto" class="small">Entry Fee: ‚Çπ${match.entryFee || 0} ‚Ä¢ Players: ${players.length} ‚Ä¢ Prize System: ${escapeHtml(prizeSystem)}</div>
        </div>

        <table>
          <thead>
            <tr><th>Select</th><th>Player</th><th>Team</th><th>Kills</th><th>Screenshot</th></tr>
          </thead>
          <tbody>
            ${rowsHtml}
          </tbody>
        </table>

        <div class="controls">
          <div class="flex-row"><label class="small">Select winner player (admin)</label></div>
          <div style="margin-left:auto" class="flex-row">
            <button class="btn" onclick="previewPayout('${match._id}', ${Number(match.entryFee||0)})">Preview Payout</button>
            <button class="btn btn-winner" onclick="submitComplete('${match._id}', ${Number(match.entryFee||0)})">Complete Match</button>
            <button class="btn btn-danger" onclick="deleteMatch('${match._id}')">Delete Match</button>
          </div>
        </div>

        <!-- Preview container (must exist to avoid null error) -->
        <div id="preview_payout_${match._id}" class="resultPreview" style="display:none"></div>
      </div>
    `;
  });

  el("#matches").innerHTML = out.join("");
}

/* simple escaper for names/UIDs */
function escapeHtml(str) {
  if (str === null || str === undefined) return "";
  return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}

/* ========== PREVIEW PAYOUT ========== */
function previewPayout(matchId, entryFee) {
  // get table rows & selected radio
  const matchEl = el(`#match_${matchId}`);
  if (!matchEl) return alert("Match not found in DOM");

  const rows = [...matchEl.querySelectorAll("tbody tr")];
  const selected = matchEl.querySelector("input[type=radio]:checked");
  if (!selected) {
    return alert("Please select a winner first (radio button).");
  }
  const winnerRow = selected.closest("tr");
  const winnerId = winnerRow?.dataset?.userid;
  const winnerName = winnerRow?.children[1]?.innerText?.split("\n")[0].trim() || "Winner";

  // detect board game
  const gameText = (matchEl.querySelector(".meta .small")?.innerText || "").toLowerCase();
  const ignoreKills = ["ludo","carrom","8 ball pool","cricket"].some(g => gameText.includes(g));

  // amounts
  const totalPlayers = rows.length;
  const totalCollected = Number(entryFee) * totalPlayers;
  const adminCut = Math.round(totalCollected * 0.08);
  const prizePool = Math.max(0, totalCollected - adminCut);

  // build preview html
  let html = `<div style="display:flex;gap:12px;flex-direction:column">`;
  html += `<div><b>Admin Selected Winner:</b> ${escapeHtml(winnerName)}</div>`;
  html += `<div style="font-size:13px;color:var(--muted)">Winner UID: <b>${escapeHtml(winnerId)}</b></div>`;
  html += `<div style="margin-top:6px">Total players: ${totalPlayers}</div>`;
  html += `<div>Total collected: ‚Çπ${totalCollected}</div>`;
  html += `<div>Admin cut (8%): ‚Çπ${adminCut}</div>`;
  html += `<hr style="border-color:#333;margin:8px 0">`;
  html += `<div style="font-size:16px"><b>Winner receives: ‚Çπ${prizePool}</b></div>`;
  if (!ignoreKills) {
    html += `<div style="font-size:13px;color:var(--muted)">Note: kills input will be used for non-board games if prize system is kill-based.</div>`;
  } else {
    html += `<div style="font-size:13px;color:var(--muted)">Board game ‚Äî kills ignored, admin selection controls payout.</div>`;
  }
  html += `</div>`;

  const box = el(`#preview_payout_${matchId}`);
  if (!box) return alert("Preview container missing (this should not happen)");
  box.style.display = "block";
  box.innerHTML = html;
  box.scrollIntoView({ behavior: "smooth", block: "center" });
}

/* ========== SUBMIT COMPLETE ========== */
async function submitComplete(matchId, entryFee) {
  const matchEl = el(`#match_${matchId}`);
  if (!matchEl) return alert("Match not found");

  const selected = matchEl.querySelector("input[type=radio]:checked");
  if (!selected) return alert("Please select a winner (radio).");
  const winnerId = selected.closest("tr")?.dataset?.userid;
  if (!winnerId) return alert("Winner user id not found");

  // detect board games
  const gameText = (matchEl.querySelector(".meta .small")?.innerText || "").toLowerCase();
  const ignoreKills = ["ludo","carrom","8 ball pool","cricket"].some(g => gameText.includes(g));

  // prepare kills array for backend compatibility
  const rows = [...matchEl.querySelectorAll("tbody tr")];
  const kills = rows.map(r => {
    const uid = r.dataset.userid;
    if (ignoreKills) {
      return { userId: uid, kills: 0 };
    } else {
      // if input exists, use it; otherwise set 0 except winner -> 1 (to avoid kill-required)
      const inp = r.querySelector("input.inputKills");
      if (inp) return { userId: uid, kills: Number(inp.value || 0) };
      return { userId: uid, kills: uid === winnerId ? 1 : 0 };
    }
  });

  if (!confirm("Are you sure you want to complete this match and pay the admin-selected winner?")) return;

  try {
    showLoading(true);

    const res = await fetch(`${API_BASE}/admin/match/completes`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({
        matchId,
        winnerTeam: winnerId,
        kills,
        prizeSystem: "" // optional; backend may determine from match record
      })
    });

    const data = await res.json();
    if (!data.success) {
      alert(data.msg || "Server responded with failure");
      console.error("complete response:", data);
    } else {
      alert("Match completed and payout issued to admin-selected winner üëç");
      // optional: show payout details from response
      loadMatches();
    }
  } catch (err) {
    console.error(err);
    alert("Network error while completing match");
  } finally {
    showLoading(false);
  }
}

/* ========== DELETE MATCH ========== */
async function deleteMatch(matchId) {
  if (!confirm("Permanently delete this match? This cannot be undone.")) return;
  try {
    showLoading(true);
    const res = await fetch(`${API_BASE}/admin/match/${matchId}`, {
      method: "DELETE",
      headers: { "Authorization": "Bearer " + token }
    });
    const data = await res.json();
    if (!data.success) alert(data.msg || "Failed to delete");
    else { alert("Deleted"); loadMatches(); }
  } catch (err) {
    console.error(err);
    alert("Network error while deleting");
  } finally { showLoading(false); }
}

/* ========== INIT ========== */
loadMatches();
</script>
</body>
</html>


router.post("/admin/match/complete", authAdmin, async (req, res) => {
  try {
    const { matchId, winnerTeam, kills = [], prizeSystem: incomingPrizeSystem } = req.body;
    if (!matchId) return res.status(400).json({ success: false, msg: "Missing matchId" });

    // Load match
    const match = await QuickMatch.findById(matchId)
      .populate("players.userId", "name phone uid")
      .exec();

    if (!match) return res.status(404).json({ success: false, msg: "Match not found" });

    // Game categories
    const simpleGames = ["ludo", "carrom", "8 ball pool", "cricket"];
    const killGames   = ["bgmi", "pubg", "free fire"];

    const gameName = (match.game || "").toLowerCase();
    const isSimple = simpleGames.some(g => gameName.includes(g));
    const isKill   = killGames.some(g => gameName.includes(g));

    // Prize Math
    const entryFee = Number(match.entryFee || 0);
    const playersArr = Array.isArray(match.players) ? match.players : [];
    const numPlayers = playersArr.length || 1;
    const totalCollected = entryFee * numPlayers;
    const adminCut = Math.round(totalCollected * 0.08);
    const prizePool = Math.max(0, totalCollected - adminCut);
    const prizeSystem = incomingPrizeSystem || match.prizeSystem || "team_equal";

    // Ensure wallet exists
    const ensureWallet = async (userId) => {
      let w = await Wallet.findOne({ userId });
      if (!w) w = await Wallet.create({ userId, balance: 0 });
      return w;
    };

    // Kills map
    const killsMap = Array.isArray(kills)
      ? kills.reduce((a, k) => {
          if (!k || !k.userId) return a;
          a[String(k.userId)] = Number(k.kills || 0);
          return a;
        }, {})
      : {};

    // Player info normalization
    const getPlayerId = p =>
      String((p.userId && (p.userId._id || p.userId)) || p.userId || p._id || "");

    const playersInfo = playersArr.map((p) => {
      const uid = getPlayerId(p);
      const name = (p.userId && p.userId.name) || p.name || "";
      return {
        raw: p,
        userId: uid,
        name,
        team: p.team || "",
        kills: killsMap[uid] ?? Number(p.kills || 0)
      };
    });

    /* ===========================================================
       1) ADMIN SELECTED WINNER (manual selection)
       =========================================================== */
    if (!winnerTeam && !isKill) {
      return res.status(400).json({ success: false, msg: "Select winner for simple game." });
    }

    // Admin-selected single user
    let payouts = [];
    let userResults = [];

    if (winnerTeam) {
      const winnerPlayer = playersInfo.find(p => String(p.userId) === String(winnerTeam));
      if (!winnerPlayer) return res.status(400).json({ success: false, msg: "Winner not found" });

      await ensureWallet(winnerPlayer.userId);
      await Wallet.updateOne({ userId: winnerPlayer.userId }, { $inc: { balance: prizePool } });

      await Transaction.create({
        userId: winnerPlayer.userId,
        matchId,
        type: "MATCH_REWARD",
        amount: prizePool,
        description: `${match.game} Winner`,
        sign: "+",
        createdAt: new Date()
      });

      userResults = playersInfo.map(pi => ({
        userId: pi.userId,
        name: pi.name,
        kills: pi.kills,
        prize: (pi.userId === winnerPlayer.userId) ? prizePool : 0,
        result: (pi.userId === winnerPlayer.userId) ? "win" : "loss"
      }));

      match.status = "completed";
      match.winnerTeam = "ADMIN_SELECTED";
      match.winnerIds = [winnerPlayer.userId];
      match.prizeGiven = prizePool;
      match.userResults = userResults;
      match.completedAt = new Date();
      await match.save();

      return res.json({ success: true, msg: "Match completed ‚Äî Admin selected winner", payout: prizePool });
    }

    /* ===========================================================
       2) KILL GAMES
       =========================================================== */
    if (isKill) {
      // 1v1 kill match
      if (String(match.type).toLowerCase() === "1v1") {
        if (!Object.keys(killsMap).length)
          return res.status(400).json({ success: false, msg: "Kills required" });

        const sorted = [...playersInfo].sort((a, b) => b.kills - a.kills);
        const winnerId = sorted[0].userId;

        await ensureWallet(winnerId);
        await Wallet.updateOne({ userId: winnerId }, { $inc: { balance: prizePool } });

        await Transaction.create({
          userId: winnerId,
          matchId,
          type: "MATCH_REWARD",
          amount: prizePool,
          description: "1v1 Kill Match Winner",
          sign: "+",
          createdAt: new Date()
        });

        userResults = playersInfo.map(pi => ({
          userId: pi.userId,
          name: pi.name,
          kills: pi.kills,
          prize: (pi.userId === winnerId) ? prizePool : 0,
          result: (pi.userId === winnerId) ? "win" : "loss"
        }));

        match.status = "completed";
        match.winnerTeam = "KILL_SOLO";
        match.winnerIds = [winnerId];
        match.prizeGiven = prizePool;
        match.userResults = userResults;
        match.completedAt = new Date();
        await match.save();

        return res.json({ success: true, msg: "1v1 Kill Match Completed", payout: prizePool });
      }

      // Team kill match
      if (!winnerTeam) return res.status(400).json({ success: false, msg: "Winner team required" });

      const half = Math.ceil(playersInfo.length / 2);
      const playersWithTeams = playersInfo.map((p, idx) => ({
        ...p,
        team: p.team || (idx < half ? "LION" : "TIGER")
      }));

      const winners = playersWithTeams.filter(p =>
        String(p.team).toUpperCase() === String(winnerTeam).toUpperCase()
      );

      if (!winners.length)
        return res.status(400).json({ success: false, msg: "No players in winner team" });

      if (prizeSystem === "kill_based") {
        const totalKills = winners.reduce((s, x) => s + x.kills, 0);
        for (const w of winners) {
          const share = totalKills
            ? Math.round((w.kills / totalKills) * prizePool)
            : Math.round(prizePool / winners.length);

          await ensureWallet(w.userId);
          await Wallet.updateOne({ userId: w.userId }, { $inc: { balance: share } });

          await Transaction.create({
            userId: w.userId,
            matchId,
            type: "MATCH_REWARD",
            amount: share,
            description: "Team Kill Reward",
            sign: "+",
            createdAt: new Date()
          });

          payouts.push({ userId: w.userId, prize: share });
        }
      } else {
        const share = Math.round(prizePool / winners.length);
        for (const w of winners) {
          await ensureWallet(w.userId);
          await Wallet.updateOne({ userId: w.userId }, { $inc: { balance: share } });

          await Transaction.create({
            userId: w.userId,
            matchId,
            type: "MATCH_REWARD",
            amount: share,
            description: "Team Equal Reward",
            sign: "+",
            createdAt: new Date()
          });

          payouts.push({ userId: w.userId, prize: share });
        }
      }

      userResults = playersWithTeams.map(p => {
        const got = payouts.find(x => x.userId === p.userId);
        return {
          userId: p.userId,
          name: p.name,
          team: p.team,
          kills: p.kills,
          prize: got ? got.prize : 0,
          result: got ? "win" : "loss"
        };
      });

      match.status = "completed";
      match.winnerTeam = winnerTeam;
      match.winnerIds = winners.map(w => w.userId);
      match.prizeGiven = prizePool;
      match.userResults = userResults;
      match.completedAt = new Date();
      await match.save();

      return res.json({ success: true, msg: "Team Kill Match Completed", payouts });
    }

    return res.status(400).json({ success: false, msg: "Invalid game type" });

  } catch (err) {
    console.error("Complete match error:", err);
    return res.status(500).json({ success: false, msg: "Server Error", error: err.message });
  }
});


<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin ‚Äî Complete Match Results & Payout</title>
<style>
  :root{
    --bg:#0b0b0b; --card:#111; --accent:#00d5ff; --muted:#9aa; --ok:#4ade80; --danger:#ff5b5b;
  }
  body{
    font-family: Inter, Poppins, system-ui, sans-serif;
    background:var(--bg); color:#fff; padding:18px;
  }
  h1{ color:var(--accent); text-align:center; margin-bottom:18px; }
  .wrap{ max-width:1100px; margin:0 auto; }
  .match{ background:var(--card); padding:14px; border-radius:10px; margin-bottom:18px;
          border:1px solid rgba(0,213,255,0.06); }
  .meta{ display:flex; gap:12px; align-items:center; margin-bottom:12px; }
  .meta b{ color:var(--accent); }
  table{ width:100%; border-collapse:collapse; margin-top:10px; }
  th,td{ padding:8px; border-bottom:1px solid rgba(255,255,255,0.04); text-align:left; font-size:14px; vertical-align:middle;}
  th{ color:var(--accent); }
  .thumb{ width:72px; height:64px; object-fit:cover; border-radius:6px; cursor:pointer; border:1px solid rgba(0,213,255,0.06); }
  .controls{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; align-items:center; }
  .controls-right{ margin-left:auto; display:flex; gap:8px; align-items:center; }
  .btn{ background:var(--accent); color:#000; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
  .btn:disabled{ opacity:.6; cursor:not-allowed; }
  .btn-danger{ background:var(--danger); color:#fff; }
  .btn-win{ background:var(--ok); color:#000; font-weight:700; padding:6px 10px; border-radius:8px; border:none; cursor:pointer; }
  .small{ font-size:13px; color:var(--muted); }
  .resultPreview{ background:#0f1720; padding:10px; border-radius:8px; margin-top:10px; border:1px solid rgba(255,255,255,0.03); }
  .inputKills{ width:80px; padding:6px; border-radius:6px; border:1px solid #222; background:#0b0b0b; color:#fff; }
  .info{ color:var(--muted); font-size:13px; }
  .loading{ color:var(--accent); text-align:center; margin:14px 0; }
  .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.85); align-items:center; justify-content:center; z-index:9999; }
  .modal img{ max-width:90%; max-height:90%; border-radius:8px; border:4px solid var(--accent); }
  .closeX{ position:absolute; top:18px; right:22px; color:var(--accent); font-size:28px; cursor:pointer; }
  .label{ font-size:13px; color:var(--muted); margin-right:6px; }
  select,input[type="text"]{ background:#0b0b0b; border:1px solid #222; color:#fff; padding:6px; border-radius:6px; }
  @media (max-width:720px){
    .meta{ flex-direction:column; align-items:flex-start; }
    .controls-right{ margin-left:0; width:100%; justify-content:flex-end; }
    .controls{ flex-direction:column; align-items:flex-start; }
    .btn{ width:100%; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Admin ‚Äî Complete Match Results & Payout</h1>

    <div id="error" class="info" style="display:none;margin-bottom:12px"></div>
    <div id="loading" class="loading">Loading matches...</div>

    <!-- Top controls -->
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:12px">
      <div class="label">API Base:</div>
      <input id="apiBaseInput" type="text" value="http://localhost:5000/api/wallet" style="min-width:320px">
      <button class="btn" id="saveApiBtn">Save</button>
      <div style="margin-left:auto">
        <button class="btn btn-danger" id="clearTokenBtn">Clear token</button>
      </div>
    </div>

    <div id="matches"></div>
  </div>

  <!-- Screenshot modal -->
  <div class="modal" id="modal">
    <span class="closeX" id="closeModalBtn">√ó</span>
    <img id="modalImg" src="" alt="screenshot">
  </div>

<script>
/* ------------------ Config / Helpers ------------------ */
let API_BASE = localStorage.getItem('adminApiBase') || "http://localhost:5000/api/wallet";
document.getElementById('apiBaseInput').value = API_BASE;
const token = localStorage.getItem("token") || "";

document.getElementById('saveApiBtn').addEventListener("click", ()=>{
  API_BASE = document.getElementById('apiBaseInput').value.trim() || API_BASE;
  localStorage.setItem('adminApiBase', API_BASE);
  alert('API base saved: ' + API_BASE);
});

document.getElementById('clearTokenBtn').addEventListener("click", ()=>{
  localStorage.removeItem('token');
  alert('Admin token cleared.');
});

document.getElementById('closeModalBtn').addEventListener("click", ()=>{ document.getElementById('modal').style.display='none'; });

function showError(msg){ const e = document.getElementById("error"); e.style.display = msg ? "block" : "none"; e.innerText = msg || ""; }
function showLoading(flag){ document.getElementById("loading").style.display = flag ? "block" : "none"; }
function openModal(src){ const modal = document.getElementById("modal"); document.getElementById("modalImg").src = src; modal.style.display='flex'; }
function escapeHtml(s){ if(s===null||s===undefined) return ""; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* per-match selection: either { type:'user', id:userId } or { type:'team', id:'LION' } */
const selection = {};
const SIMPLE_GAMES = ["ludo","carrom","8 ball pool","8ball","cricket"];
const KILL_GAMES   = ["bgmi","pubg","free fire","freefire","free-fire"];

/* ------------------ Load matches ------------------ */
async function loadMatches(){
  showError("");
  if(!token){ showError("Admin token missing ‚Äî store admin token at localStorage key 'token'"); showLoading(false); return; }
  showLoading(true);
  try{
    const r = await fetch(`${API_BASE}/admin/match/results`, { method: "GET", headers: { "Authorization": "Bearer " + token } });
    const data = await r.json();
    if(!data.success){ showError(data.msg || "Failed loading matches"); document.getElementById("matches").innerHTML = ""; return; }
    renderMatches(data.list || []);
  }catch(err){
    console.error(err);
    showError("Network error while loading matches");
    document.getElementById("matches").innerHTML = "";
  } finally { showLoading(false); }
}

/* ------------------ Render Matches ------------------ */
function renderMatches(list){
  const container = document.getElementById("matches");
  container.innerHTML = "";
  if(!Array.isArray(list) || list.length === 0){
    container.innerHTML = `<div class="info">No match results available.</div>`;
    return;
  }

  list.forEach(match => {
    // normalize results list
    const rawPlayers = Array.isArray(match.results) && match.results.length ? match.results : (Array.isArray(match.userResults) && match.userResults.length ? match.userResults : (Array.isArray(match.players) ? match.players : []));
    const players = rawPlayers.map((p, idx) => {
      let userId = "";
      let name = p.name || "-";
      let uidDisplay = p.uid || (p.userId && p.userId.uid) || "";
      let team = p.team || p.userTeam || "";
      let kills = Number(p.kills || 0);
      let screenshot = p.screenshotUrl || p.screenshot || "";
      let uploadedAt = p.uploadedAt || p.createdAt || p.uploaded || null;

      if(p.userId){
        if(typeof p.userId === "object"){
          userId = p.userId._id || p.userId.id || "";
          name: p.name || (p.userId && p.userId.name) || "-";
          
          
        } else {
          userId = p.userId;
        }
      } else {
        userId = p.user || p._id || String(idx);
      }

      return {
        userId: String(userId),
        name: String(name),
        uidDisplay: String(uidDisplay || ""),
        team: String(team || ""),
        kills,
        screenshotUrl: String(screenshot || ""),
        uploadedAt: uploadedAt || null,
        prize: Number(p.prize || 0),
        result: p.result || ""
      };
    });

    // Build match DOM block
    const matchDiv = document.createElement("div");
    matchDiv.className = "match";
    matchDiv.id = "match_" + (match._id || Math.random().toString(36).slice(2));

    // header/meta
    const prizeSystem = match.prizeSystem || "team_equal";
    const matchGame = String(match.game || "").toLowerCase();

    // create HTML safely using escaped pieces
    let html = '';
    html += `<div class="meta">`;
    html += `<div><b>Match #${escapeHtml(match.matchNumber || match._id || "")}</b>`;
    html += `<div class="small">${escapeHtml(match.game || "Unknown")} ‚Ä¢ ${escapeHtml(match.mode || "-")} ‚Ä¢ ${escapeHtml(match.type || "-")}</div></div>`;
    html += `<div class="controls-right"><label class="label small">Prize system</label>`;
    html += `<select id="ps_${escapeHtml(String(match._id))}">`;
    html += `<option value="">(use match)</option>`;
    html += `<option value="team_equal"${prizeSystem==="team_equal" ? " selected" : ""}>team_equal</option>`;
    html += `<option value="kill_based"${prizeSystem==="kill_based" ? " selected" : ""}>kill_based</option>`;
    html += `</select></div></div>`;

    // table header
    html += `<table><thead><tr><th>Winner</th><th>Player</th><th>Team</th><th>Kills</th><th>Screenshot</th><th>Uploaded</th><th>Prize</th></tr></thead><tbody>`;

    players.forEach(p => {
      const rowBg = p.result === 'win' ? ' style="background:rgba(74,222,128,0.06)"' : '';
      html += `<tr data-userid="${escapeHtml(p.userId)}"${rowBg}>`;
      html += `<td style="white-space:nowrap"><button type="button" class="btn-win select-user" data-match="${escapeHtml(match._id)}" data-user="${escapeHtml(p.userId)}" data-name="${escapeHtml(p.name)}">WIN</button></td>`;
      html += `<td>${escapeHtml(p.name)}<br><small class="small">${escapeHtml(p.uidDisplay)}</small></td>`;
      html += `<td>${escapeHtml(p.team || "-")}</td>`;

      // kills input only for kill games at runtime; here we show input but leave it to JS to enable logic
      const isSimple = SIMPLE_GAMES.some(g => matchGame.includes(g));
      html += `<td>${ isSimple ? '&mdash;' : `<input class="inputKills" type="number" value="${escapeHtml(String(p.kills))}" data-user="${escapeHtml(p.userId)}" min="0">` }</td>`;

      html += `<td>${ p.screenshotUrl ? `<img class="thumb" src="${escapeHtml(p.screenshotUrl)}" alt="screenshot">` : `<span class="small">No screenshot</span>` }</td>`;
      html += `<td class="small">${ p.uploadedAt ? escapeHtml(new Date(p.uploadedAt).toLocaleString()) : '-' }</td>`;
      html += `<td class="small">‚Çπ${escapeHtml(String(p.prize || 0))}</td>`;
      html += `</tr>`;
    });

    html += `</tbody></table>`;

    // controls
    html += `<div class="controls">`;
    html += `<div><label class="label small">Or select winner team:</label>`;
    html += `<label class="small"><input type="radio" name="team_${escapeHtml(String(match._id))}" value="LION" class="team-select"> LION</label>`;
    html += `<label class="small"><input type="radio" name="team_${escapeHtml(String(match._id))}" value="TIGER" class="team-select"> TIGER</label>`;
    html += `</div>`;
    html += `<div class="controls-right">`;
    html += `<button type="button" class="btn preview-btn" data-matchid="${escapeHtml(match._id)}" data-entryfee="${escapeHtml(String(Number(match.entryFee||0)))}" data-type="${escapeHtml(String(match.type||""))}" data-prizesystem="${escapeHtml(String(prizeSystem))}" data-game="${escapeHtml(String(match.game||""))}">Preview Payout</button>`;
    html += `<button type="button" class="btn complete-btn" data-matchid="${escapeHtml(match._id)}" data-type="${escapeHtml(String(match.type||""))}">Complete Match</button>`;
    html += `<button type="button" class="btn btn-danger delete-btn" data-matchid="${escapeHtml(match._id)}">Delete Match</button>`;
    html += `</div></div>`;
    html += `<div id="preview_${escapeHtml(match._id)}" class="resultPreview" style="display:none"></div>`;

    matchDiv.innerHTML = html;
    container.appendChild(matchDiv);
  });

  attachMatchHandlers();
}

/* ------------------ Attach handlers safely ------------------ */
function attachMatchHandlers(){
  // select-user buttons
  document.querySelectorAll(".select-user").forEach(btn=>{
    btn.removeEventListener("click", onSelectUser); // safe remove
    btn.addEventListener("click", onSelectUser);
  });

  // team radio selectors
  document.querySelectorAll(".team-select").forEach(radio=>{
    radio.removeEventListener("change", onSelectTeam);
    radio.addEventListener("change", onSelectTeam);
  });

  // preview buttons
  document.querySelectorAll(".preview-btn").forEach(btn=>{
    btn.removeEventListener("click", onPreview);
    btn.addEventListener("click", onPreview);
  });

  // complete buttons
  document.querySelectorAll(".complete-btn").forEach(btn=>{
    btn.removeEventListener("click", onComplete);
    btn.addEventListener("click", onComplete);
  });

  // delete buttons
  document.querySelectorAll(".delete-btn").forEach(btn=>{
    btn.removeEventListener("click", onDelete);
    btn.addEventListener("click", onDelete);
  });

  // thumbnails open modal
  document.querySelectorAll(".thumb").forEach(img=>{
    img.removeEventListener("click", onThumbClick);
    img.addEventListener("click", onThumbClick);
  });
}

function onSelectUser(e){
  const matchId = e.currentTarget.dataset.match;
  const userId = e.currentTarget.dataset.user;
  const name = e.currentTarget.dataset.name;
  selection[matchId] = { type: 'user', id: String(userId) };
  alert('Selected WINNER: ' + name);
}

function onSelectTeam(e){
  const name = e.currentTarget.name; // team_<matchId>
  const matchId = name.replace(/^team_/, '');
  const team = e.currentTarget.value;
  selection[matchId] = { type: 'team', id: team };
}

function onThumbClick(e){
  const src = e.currentTarget.getAttribute('src');
  if(src) openModal(src);
}

function onPreview(e){
  const btn = e.currentTarget;
  const matchId = btn.dataset.matchid;
  const entryFee = Number(btn.dataset.entryfee || 0);
  const matchType = btn.dataset.type || "";
  const serverPrizeSystem = btn.dataset.prizesystem || "";
  const game = btn.dataset.game || "";
  previewPayout(matchId, entryFee, matchType, serverPrizeSystem, game);
}

function onComplete(e){
  const btn = e.currentTarget;
  submitComplete(btn.dataset.matchid, btn.dataset.type);
}

function onDelete(e){
  const matchId = e.currentTarget.dataset.matchid;
  deleteMatch(matchId);
}

/* ------------------ Preview Payout ------------------ */
function previewPayout(matchId, entryFee, matchType, serverPrizeSystem, matchGameRaw){
  const previewBox = document.getElementById("preview_" + matchId);
  if(!previewBox) return;
  previewBox.style.display = "block";

  const rows = Array.from(document.querySelectorAll(`#match_${matchId} tbody tr`));
  const players = rows.map(r => {
    return {
      userId: r.dataset.userid,
      kills: Number(r.querySelector('.inputKills') ? r.querySelector('.inputKills').value || 0 : 0),
      name: r.children[1]?.innerText?.split("\n")[0].trim() || r.dataset.userid,
      team: r.children[2]?.innerText?.trim() || ""
    };
  });

  const totalPlayers = players.length || 1;
  const totalCollected = Number(entryFee) * totalPlayers;
  const adminCut = Math.round(totalCollected * 0.08);
  const prizePool = Math.max(0, totalCollected - adminCut);
  const overridePS = document.getElementById(`ps_${matchId}`)?.value;
  const prizeSystem = overridePS || serverPrizeSystem || "team_equal";

  const matchGame = (matchGameRaw || "").toLowerCase();
  const isSimple = SIMPLE_GAMES.some(g => matchGame.includes(g));
  const isKill = KILL_GAMES.some(g => matchGame.includes(g));

  const sel = selection[matchId] || null;
  let html = `<div style="padding:10px;background:#111;border-radius:8px">`;
  html += `<div><strong>Match:</strong> ${escapeHtml(matchGameRaw)}</div>`;
  html += `<div style="color:#9aa;font-size:13px">Players: ${totalPlayers} ‚Ä¢ Collected: ‚Çπ${totalCollected} ‚Ä¢ Admin cut (8%): ‚Çπ${adminCut}</div>`;
  html += `<div style="color:#9aa;font-size:13px">Prize system: ${escapeHtml(prizeSystem)}</div>`;
  html += `<hr style="border-color:#333;margin:8px 0">`;

  if(sel && sel.type === 'user'){
    const winner = players.find(p => String(p.userId) === String(sel.id));
    html += `<div><strong>Admin-selected winner</strong></div>`;
    html += `<div>Winner: <strong>${escapeHtml(winner ? winner.name : sel.id)}</strong></div>`;
    html += `<div style="margin-top:8px;font-size:16px"><strong>Winner receives: ‚Çπ${prizePool}</strong></div>`;
    html += `</div>`;
    previewBox.innerHTML = html;
    return;
  }

  if(isSimple){
    html += `<div><strong>Simple game detected (${escapeHtml(matchGameRaw)}).</strong></div>`;
    html += `<div class="small" style="margin-top:6px">Select a single player using WIN button. Winner receives full prize pool ‚Çπ${prizePool}.</div>`;
    html += `</div>`;
    previewBox.innerHTML = html;
    return;
  }

  // kill-games preview (1v1 or team)
  if(isKill){
    if((matchType || "").toLowerCase() === "1v1"){
      const sorted = [...players].sort((a,b)=>b.kills - a.kills);
      const top = sorted[0] || { name: '-', kills: 0 };
      html += `<div><strong>1v1 kill match</strong></div>`;
      html += `<div>Top player: <strong>${escapeHtml(top.name)}</strong> ‚Äî Kills: ${top.kills}</div>`;
      html += `<div style="margin-top:8px;font-size:16px"><strong>Payout: ‚Çπ${prizePool}</strong></div>`;
      html += `</div>`;
      previewBox.innerHTML = html;
      return;
    }

    // team preview
    if(selection[matchId] && selection[matchId].type === 'team'){
      const teamName = selection[matchId].id;
      const winners = players.filter(p => (p.team || "").toUpperCase() === String(teamName).toUpperCase());
      if(!winners.length){
        html += `<div style="color:var(--danger)">No players found for team ${escapeHtml(teamName)}. Backend will auto-assign if needed.</div></div>`;
        previewBox.innerHTML = html;
        return;
      }
      html += `<div><strong>Team winner:</strong> ${escapeHtml(teamName)}</div>`;
      html += `<div class="small" style="margin-bottom:8px">Prize system: <strong>${escapeHtml(prizeSystem)}</strong></div>`;
      if(prizeSystem === "team_equal"){
        const share = Math.round(prizePool / winners.length);
        html += `<table style="width:100%;border-collapse:collapse"><tr><th>Player</th><th>Kills</th><th>Share</th></tr>`;
        winners.forEach(p => html += `<tr><td>${escapeHtml(p.name)}</td><td>${p.kills}</td><td>‚Çπ${share}</td></tr>`);
        html += `</table>`;
        html += `<div style="margin-top:8px"><strong>Total awarded:</strong> ‚Çπ${share * winners.length}</div>`;
      } else {
        const totalKills = winners.reduce((s,p)=>s+p.kills,0);
        html += `<table style="width:100%;border-collapse:collapse"><tr><th>Player</th><th>Kills</th><th>Share</th></tr>`;
        winners.forEach(p => {
          const share = totalKills > 0 ? Math.round((p.kills / totalKills) * prizePool) : Math.round(prizePool / winners.length);
          html += `<tr><td>${escapeHtml(p.name)}</td><td>${p.kills}</td><td>‚Çπ${share}</td></tr>`;
        });
        html += `</table>`;
        html += `<div style="margin-top:8px"><strong>Prize pool:</strong> ‚Çπ${prizePool}</div>`;
      }
      html += `</div>`;
      previewBox.innerHTML = html;
      return;
    }

    html += `<div style="color:var(--muted)">Kill game detected. Select a team (LION/TIGER) or pick a single player as winner. For 1v1 supply kills in inputs.</div></div>`;
    previewBox.innerHTML = html;
    return;
  }

  // fallback message
  html += `<div style="color:var(--muted)">No winner selected. Choose a player with WIN button or select a team (LION/TIGER).</div></div>`;
  previewBox.innerHTML = html;
}

/* ------------------ Submit Complete ------------------ */
async function submitComplete(matchId, matchType){
  const rows = Array.from(document.querySelectorAll(`#match_${matchId} tbody tr`));
  const kills = rows.map(r => ({ userId: r.dataset.userid, kills: Number(r.querySelector('.inputKills')?.value || 0) }));
  const prizeSystem = document.getElementById(`ps_${matchId}`)?.value || "";
  const sel = selection[matchId] || null;

  if(!sel && (matchType || "").toLowerCase() !== "1v1"){
    alert("No winner chosen ‚Äî click WIN next to a player (single) or select a winning team (LION/TIGER).");
    return;
  }

  const winnerTeam = sel ? sel.id : null;
  if(!confirm("Are you sure you want to complete this match and issue payouts?")) return;

  try{
    showLoading(true);
    const res = await fetch(`${API_BASE}/admin/match/complete`, {
      method: "POST",
      headers: { "Content-Type":"application/json", "Authorization":"Bearer " + token },
      body: JSON.stringify({ matchId, winnerTeam, kills, prizeSystem: prizeSystem || undefined })
    });
    const data = await res.json();
    if(!data.success){
      alert(data.msg || "Server returned failure");
      console.error("Complete response:", data);
      return;
    }

    alert("Match completed ‚úÖ ‚Äî payouts: " + (data.payouts ? JSON.stringify(data.payouts) : data.payout || "see server response"));
    delete selection[matchId];
    loadMatches();
  }catch(err){
    console.error(err);
    alert("Network error while completing match");
  }finally{
    showLoading(false);
  }
}

/* ------------------ Delete Match ------------------ */
async function deleteMatch(matchId){
  if(!confirm("Permanently delete this match? This cannot be undone.")) return;
  try{
    showLoading(true);
    const r = await fetch(`${API_BASE}/admin/match/${matchId}`, { method:"DELETE", headers: { "Authorization":"Bearer " + token } });
    const data = await r.json();
    if(!data.success) alert(data.msg || "Delete failed");
    else { alert("Deleted"); loadMatches(); }
  }catch(err){
    console.error(err);
    alert("Network error while deleting match");
  }finally{ showLoading(false); }
}

/* ------------------ Init ------------------ */
loadMatches();
</script>
</body>
</html>
