<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin â€” Match Dashboard</title>
<style>
  body { font-family: 'Poppins', sans-serif; background: #0b0b0b; color: #fff; margin: 0; padding: 20px; }
  h1 { margin-bottom: 20px; }
  .tabs { display:flex; gap:10px; margin-bottom:18px; }
  .tab-btn { padding:8px 14px; border-radius:6px; border:none; background:#111; color:#fff; cursor:pointer; }
  .tab-btn.active { background:#00faff; color:#000; }
  .controls { display:flex; gap:8px; align-items:center; margin-bottom:14px; flex-wrap:wrap; }
  .btn { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; background:#00d5ff; color:#000; font-weight:600; }
  .danger { background:#ff4d4d; color:#fff; padding:6px 10px; border-radius:6px; border:none; cursor:pointer; }
  .pair { background:#ffa500; color:#000; padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
  table { width:100%; border-collapse:collapse; margin-bottom:18px; }
  th, td { padding:8px; border:1px solid #333; text-align:left; font-size:13px; }
  th { background:#111; color:#00faff; }
  tr:nth-child(even) { background:#161616; }
  .small { font-size:12px; color:#aaa; margin-left:8px; }
  .msg { margin-top:10px; color:#9ae; }
  .error { color:#ff8a8a; }
  .wa-btn { background:#25D366; color:#fff; border:none; padding:6px 8px; border-radius:6px; cursor:pointer; }
  .copy-btn { background:#00faff; color:#000; border:none; padding:6px 8px; border-radius:6px; cursor:pointer; }
  .template-editor { background:#0f0f0f; padding:10px; border-radius:8px; margin-left:8px; display:inline-block; }
  textarea { width:420px; max-width:100%; height:80px; background:#0b0b0b; color:#fff; border:1px solid #222; padding:8px; border-radius:6px; }
  @media (max-width:820px){ .controls { flex-direction:column; align-items:flex-start } textarea { width:100%; } }
</style>
</head>
<body>
  <h1>Admin â€” Match Dashboard</h1>

  <div class="tabs">
    <button class="tab-btn active" data-tab="joined">Joined</button>
    <button class="tab-btn" data-tab="unpaired">Unpaired</button>
    <button class="tab-btn" data-tab="paired">Paired/Ongoing</button>
    <button class="tab-btn" data-tab="completed">Completed</button>
  </div>

  <div class="controls">
    <button id="refreshBtn" class="btn">ðŸ”„ Refresh</button>
    <button id="pairBtn" class="pair" style="display:none;">Pair Selected</button>
    <button id="exportWA" class="btn">Edit WA Template</button>

    <div class="template-editor" id="templateBox" style="display:none;">
      <div style="display:flex; gap:8px; align-items:center;">
        <strong class="small">WA Template</strong>
        <button id="saveTemplate" class="btn" style="padding:6px 8px;">Save</button>
        <button id="closeTemplate" class="danger" style="padding:6px 8px;">Close</button>
      </div>
      <div style="margin-top:8px;">
        <textarea id="waTemplate" placeholder="Use placeholders: {name} {uid} {game} {mode} {type} {entryFee} {matchId} {team} {phone}"></textarea>
      </div>
      <div class="small" style="margin-top:6px;">Example: Hello {name}, your {game} match (ID: {matchId}) â€” Team: {team} â€” Entry: â‚¹{entryFee}.</div>
    </div>
  </div>

  <div id="msg" class="msg"></div>

  <!-- Joined -->
  <div id="joinedSection">
    <h2>Joined Members</h2>
    <button class="danger" onclick="deleteAllJoined()">Delete All Joined Members</button>
    <table>
      <thead>
        <tr>
          <th>Name</th><th>UID</th><th>Phone</th><th>User ID</th><th>Joined At</th>
          <th>Game</th><th>Mode</th><th>Type</th><th>Entry Fee</th><th>WhatsApp</th>
          <th>Status</th><th>Team</th><th>Action</th>
        </tr>
      </thead>
      <tbody id="joinedBody"></tbody>
    </table>
  </div>

  <!-- Unpaired -->
  <div id="unpairedSection" style="display:none">
    <h2>Unpaired Members</h2>
    <button class="danger" onclick="deleteAllUnpaired()">Delete All Unpaired</button>
    <table>
      <thead>
        <tr>
          <th>Select</th><th>Name</th><th>UID</th><th>Phone</th><th>User ID</th><th>Joined At</th>
          <th>Game</th><th>Mode</th><th>Type</th><th>Entry Fee</th><th>WhatsApp</th><th>Team</th><th>Action</th>
        </tr>
      </thead>
      <tbody id="unpairedBody"></tbody>
    </table>
  </div>

  <!-- Paired -->
  <div id="pairedSection" style="display:none">
    <h2>Paired / Ongoing Matches</h2>
    <button class="danger" onclick="deleteAllPaired()">Delete All Paired Matches</button>
    <table>
      <thead>
        <tr>
          <th>Name</th><th>UID</th><th>Phone</th><th>User ID</th><th>Joined At</th>
          <th>Game</th><th>Mode</th><th>Type</th><th>Entry Fee</th>
          <th>WhatsApp</th><th>Prize</th><th>Match No</th><th>Status</th><th>Team</th><th>Action</th>
        </tr>
      </thead>
      <tbody id="pairedBody"></tbody>
    </table>
  </div>

  <!-- Completed -->
  <div id="completedSection" style="display:none">
    <h2>Completed Matches</h2>
    <table>
      <thead>
        <tr>
          <th>Name</th><th>UID</th><th>Phone</th><th>User ID</th><th>Joined At</th>
          <th>Game</th><th>Mode</th><th>Type</th><th>Entry Fee</th>
          <th>WhatsApp</th><th>Prize</th><th>Match No</th><th>Status</th><th>Team</th>
        </tr>
      </thead>
      <tbody id="completedBody"></tbody>
    </table>
  </div>

<script>
/* --------- CONFIG ---------- */
const API_BASE = 'http://localhost:5000/api/wallet'; // keep as your backend base
const token = localStorage.getItem('token'); // admin token
const headersWithAuth = () => ({ 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' });

/* UI state */
let selected = new Set(); // "matchId_userId"
let unpairedRows = []; // latest unpaired data
const waTemplateKey = 'admin_wa_template';

/* ---------- helpers ---------- */
function showMsg(text, isError=false){
  const el = document.getElementById('msg');
  el.textContent = text || '';
  el.className = isError ? 'msg error' : 'msg';
  el.style.display = text ? 'block' : 'none';
}
function formatDate(d){ try{ return new Date(d).toLocaleString(); }catch(e){ return '-'; } }
function getWATemplate(){ return localStorage.getItem(waTemplateKey) || 'Hello {name}, your match is ready. Game:{game} Type:{type} Entry: â‚¹{entryFee} Team:{team} MatchID:{matchId}'; }
function saveWATemplate(t){ localStorage.setItem(waTemplateKey, t); }

/* placeholder replacement */
function fillTemplate(tpl, data){
  return tpl.replace(/\{(\w+)\}/g, (_, k) => {
    return (data && (data[k] !== undefined && data[k] !== null)) ? String(data[k]) : '';
  });
}

/* sanitize phone number and optionally add country code */
function sanitizeNumber(raw){
  if(!raw) return '';
  const digits = String(raw).replace(/\D/g,'');
  if(!digits) return '';
  // if 10 digits, assume India -> prefix 91 (you can change this)
  if(digits.length === 10) return '91' + digits;
  // if already starts with country code (e.g. '9198...') return as-is
  return digits;
}

/* ---------- Tabs ---------- */
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    document.getElementById('joinedSection').style.display = tab==='joined' ? '' : 'none';
    document.getElementById('unpairedSection').style.display = tab==='unpaired' ? '' : 'none';
    document.getElementById('pairedSection').style.display = tab==='paired' ? '' : 'none';
    document.getElementById('completedSection').style.display = tab==='completed' ? '' : 'none';
    document.getElementById('pairBtn').style.display = tab==='unpaired' ? 'inline-block' : 'none';
    fetchAllForTab(tab);
  });
});

/* template editor controls */
document.getElementById('exportWA').addEventListener('click', ()=>{
  const box = document.getElementById('templateBox');
  box.style.display = box.style.display === 'none' ? 'block' : 'none';
  document.getElementById('waTemplate').value = getWATemplate();
});
document.getElementById('saveTemplate').addEventListener('click', ()=>{
  const val = document.getElementById('waTemplate').value.trim();
  saveWATemplate(val);
  showMsg('WA template saved');
});
document.getElementById('closeTemplate').addEventListener('click', ()=>{
  document.getElementById('templateBox').style.display = 'none';
});

/* refresh */
document.getElementById('refreshBtn').addEventListener('click', ()=> {
  const active = document.querySelector('.tab-btn.active').dataset.tab;
  fetchAllForTab(active);
});

/* pair button */
document.getElementById('pairBtn').addEventListener('click', pairSelected);

/* ---------- Fetchers ---------- */
async function fetchAllForTab(tab){
  showMsg('Loading...');
  try{
    if(tab==='joined') await loadJoined();
    else if(tab==='unpaired') await loadUnpaired();
    else if(tab==='paired') await loadPaired();
    else if(tab==='completed') await loadCompleted();
    showMsg('');
  }catch(e){
    console.error(e);
    showMsg('Error loading data', true);
  }
}

/* utility to create button elements (so we avoid inline onclicks) */
function makeButton(text, cls, onClick){
  const b = document.createElement('button');
  b.textContent = text;
  b.className = cls;
  b.addEventListener('click', onClick);
  return b;
}

/* safe text cell */
function tdText(value){
  const td = document.createElement('td');
  td.textContent = value == null ? '' : value;
  return td;
}

/* JOINED */
async function loadJoined(){
  const res = await fetch(`${API_BASE}/match/all`, { headers: headersWithAuth() });
  const json = await res.json();
  const tbody = document.getElementById('joinedBody');
  tbody.innerHTML = '';
  if(!json.success || !Array.isArray(json.data)) return;

  json.data.forEach(praw=>{
    // normalize possible shapes from backend
    const p = {
      name: praw.name || (praw.user && praw.user.name) || praw.userName || 'Unknown',
      uid: praw.uid || praw.userUid || 'N/A',
      phone: praw.phone || praw.whatsapp || (praw.user && praw.user.phone) || 'N/A',
      userId: praw.userId || praw.user?._id || praw.userId || '',
      joinedAt: praw.joinedAt || praw.createdAt,
      game: praw.game || '',
      mode: praw.mode || '',
      type: praw.type || '',
      entryFee: praw.entryFee || praw.fee || '',
      whatsapp: praw.whatsapp || praw.whatsappNumber || praw.phone || '',
      status: praw.status || '',
      team: praw.team || '-',
      matchId: praw.matchId || praw.match || praw._id || '',
    };

    const tr = document.createElement('tr');
    tr.appendChild(tdText(p.name));
    tr.appendChild(tdText(p.uid));
    tr.appendChild(tdText(p.phone));
    tr.appendChild(tdText(p.userId));
    tr.appendChild(tdText(formatDate(p.joinedAt)));
    tr.appendChild(tdText(p.game));
    tr.appendChild(tdText(p.mode));
    tr.appendChild(tdText(p.type));
    tr.appendChild(tdText(p.entryFee));

    // whatsapp cell (text + copy + wa button)
    const waTd = document.createElement('td');
    const waText = document.createElement('span');
    waText.textContent = p.whatsapp;
    waTd.appendChild(waText);

    const copyBtn = makeButton('Copy', 'copy-btn', ()=> copyText(p.whatsapp || p.phone));
    copyBtn.style.marginLeft = '8px';
    waTd.appendChild(copyBtn);

    const waBtn = makeButton('WA', 'wa-btn', ()=> openWhatsAppForPlayer(p));
    waBtn.style.marginLeft = '6px';
    waTd.appendChild(waBtn);

    tr.appendChild(waTd);

    tr.appendChild(tdText(p.status));
    tr.appendChild(tdText(p.team));

    // action column
    const actionTd = document.createElement('td');
    const delBtn = makeButton('Delete', 'danger', ()=> deleteJoined(encodeURIComponent(p.matchId), encodeURIComponent(p.userId)));
    actionTd.appendChild(delBtn);
    tr.appendChild(actionTd);

    tbody.appendChild(tr);
  });
}

/* UNPAIRED */
async function loadUnpaired(){
  const res = await fetch(`${API_BASE}/match/unpaired`, { headers: headersWithAuth() });
  const json = await res.json();
  unpairedRows = Array.isArray(json.data) ? json.data : [];
  const tbody = document.getElementById('unpairedBody');
  tbody.innerHTML = '';
  selected.clear();

  if(!json.success) return;

  unpairedRows.forEach((praw, idx)=>{
    const p = {
      matchId: praw.matchId || praw._id || praw.match || '',
      matchNumber: praw.matchNumber || praw.matchNo || '',
      userId: praw.userId || praw.user?._id || praw.userId || '',
      uid: praw.uid || 'N/A',
      name: praw.name || (praw.user && praw.user.name) || 'Unknown',
      phone: praw.phone || praw.whatsapp || (praw.user && praw.user.phone) || 'N/A',
      whatsapp: praw.whatsapp || praw.whatsappNumber || praw.phone || '',
      wallet: praw.wallet || 0,
      avatarUrl: praw.avatarUrl || null,
      game: praw.game || '',
      mode: praw.mode || '',
      type: praw.type || '',
      entryFee: praw.entryFee || praw.fee || '',
      joinedAt: praw.joinedAt || praw.createdAt,
      status: praw.status || '',
      team: praw.team || (idx % 2 === 0 ? 'LION' : 'TIGER')
    };

    const tr = document.createElement('tr');

    // select checkbox
    const selectTd = document.createElement('td');
    const chk = document.createElement('input');
    chk.type = 'checkbox';
    chk.id = `chk_${idx}`;
    chk.addEventListener('change', ()=> toggleSelect(p.matchId, p.userId));
    selectTd.appendChild(chk);
    tr.appendChild(selectTd);

    tr.appendChild(tdText(p.name));
    tr.appendChild(tdText(p.uid));
    tr.appendChild(tdText(p.phone));
    tr.appendChild(tdText(p.userId));
    tr.appendChild(tdText(formatDate(p.joinedAt)));
    tr.appendChild(tdText(p.game));
    tr.appendChild(tdText(p.mode));
    tr.appendChild(tdText(p.type));
    tr.appendChild(tdText(p.entryFee));

    const waTd = document.createElement('td');
    waTd.appendChild(document.createTextNode(p.whatsapp));
    const copyBtn = makeButton('Copy', 'copy-btn', ()=> copyText(p.whatsapp || p.phone));
    copyBtn.style.marginLeft = '8px';
    waTd.appendChild(copyBtn);

    const waBtn = makeButton('WA', 'wa-btn', ()=> openWhatsAppForPlayer(p));
    waBtn.style.marginLeft = '6px';
    waTd.appendChild(waBtn);

    tr.appendChild(waTd);

    tr.appendChild(tdText(p.team));

    const actionTd = document.createElement('td');
    const delBtn = makeButton('Delete', 'danger', ()=> deleteSingleUnpaired(encodeURIComponent(p.matchId), encodeURIComponent(p.userId)));
    actionTd.appendChild(delBtn);
    tr.appendChild(actionTd);

    tbody.appendChild(tr);
  });
}

/* PAIRED */
async function loadPaired(){
  const res = await fetch(`${API_BASE}/match/paired`, { headers: headersWithAuth() });
  const json = await res.json();
  const tbody = document.getElementById('pairedBody');
  tbody.innerHTML = '';
  if(!json.success) return;

  json.data.forEach(praw=>{
    const p = {
      name: praw.name || (praw.user && praw.user.name) || 'Unknown',
      uid: praw.uid || 'N/A',
      phone: praw.phone || praw.whatsapp || (praw.user && praw.user.phone) || 'N/A',
      userId: praw.userId || praw.user?._id || '',
      joinedAt: praw.joinedAt || praw.createdAt,
      game: praw.game || '',
      mode: praw.mode || '',
      type: praw.type || '',
      entryFee: praw.entryFee || praw.fee || '',
      whatsapp: praw.whatsapp || praw.whatsappNumber || praw.phone || '',
      prize: praw.prize || '-',
      matchNumber: praw.matchNumber || praw.matchNo || '-',
      status: praw.status || '',
      team: praw.team || '-',
      matchId: praw.matchId || praw._id || praw.match || ''
    };

    const tr = document.createElement('tr');
    tr.appendChild(tdText(p.name));
    tr.appendChild(tdText(p.uid));
    tr.appendChild(tdText(p.phone));
    tr.appendChild(tdText(p.userId));
    tr.appendChild(tdText(formatDate(p.joinedAt)));
    tr.appendChild(tdText(p.game));
    tr.appendChild(tdText(p.mode));
    tr.appendChild(tdText(p.type));
    tr.appendChild(tdText(p.entryFee));

    const waTd = document.createElement('td');
    waTd.appendChild(document.createTextNode(p.whatsapp));
    const copyBtn = makeButton('Copy', 'copy-btn', ()=> copyText(p.whatsapp || p.phone));
    copyBtn.style.marginLeft = '8px';
    waTd.appendChild(copyBtn);
    const waBtn = makeButton('WA', 'wa-btn', ()=> openWhatsAppForPlayer(p));
    waBtn.style.marginLeft = '6px';
    waTd.appendChild(waBtn);

    tr.appendChild(waTd);

    tr.appendChild(tdText(p.prize));
    tr.appendChild(tdText(p.matchNumber));
    tr.appendChild(tdText(p.status));
    tr.appendChild(tdText(p.team));

    const actionTd = document.createElement('td');
    const delBtn = makeButton('Delete', 'danger', ()=> deleteSinglePaired(encodeURIComponent(p.matchId)));
    actionTd.appendChild(delBtn);
    tr.appendChild(actionTd);

    tbody.appendChild(tr);
  });
}

/* COMPLETED */
async function loadCompleted(){
  const res = await fetch(`${API_BASE}/match/paired`, { headers: headersWithAuth() });
  const json = await res.json();
  const tbody = document.getElementById('completedBody');
  tbody.innerHTML = '';
  if(!json.success) return;

  json.data.forEach(praw=>{
    if(praw.status !== 'completed') return;
    const tr = document.createElement('tr');
    tr.appendChild(tdText(praw.name || praw.user?.name || 'Unknown'));
    tr.appendChild(tdText(praw.uid || 'N/A'));
    tr.appendChild(tdText(praw.phone || praw.whatsapp || 'N/A'));
    tr.appendChild(tdText(praw.userId || praw.user?._id || ''));
    tr.appendChild(tdText(formatDate(praw.joinedAt || praw.createdAt)));
    tr.appendChild(tdText(praw.game || ''));
    tr.appendChild(tdText(praw.mode || ''));
    tr.appendChild(tdText(praw.type || ''));
    tr.appendChild(tdText(praw.entryFee || ''));
    tr.appendChild(tdText(praw.whatsapp || ''));
    tr.appendChild(tdText(praw.prize || '-'));
    tr.appendChild(tdText(praw.matchNumber || '-'));
    tr.appendChild(tdText(praw.status || ''));
    tr.appendChild(tdText(praw.team || '-'));
    tbody.appendChild(tr);
  });
}

/* ---------- Selection ---------- */
function toggleSelect(matchId, userId){
  const key = `${matchId}_${userId}`;
  if(selected.has(key)) selected.delete(key);
  else selected.add(key);
  document.getElementById('pairBtn').style.display = selected.size ? 'inline-block' : 'none';
}

/* ---------- Pairing (manual only) ---------- */
async function pairSelected(){
  if(selected.size === 0) return alert('Select members first');
  const members = [];
  const keys = Array.from(selected);
  for(const k of keys){
    const [matchId, userId] = k.split('_');
    const p = unpairedRows.find(x => String(x.matchId) === matchId && String(x.userId) === userId);
    if(!p){ alert('Selected member not found or stale. Refresh and try again.'); return; }
    members.push({
      userId: p.userId || null,
      uid: p.uid || null,
      name: p.name || null,
      phone: p.phone || null,
      whatsapp: p.whatsapp || null,
      game: p.game,
      mode: p.mode,
      type: p.type,
      entryFee: p.entryFee
    });
  }

  const first = members[0];
  const same = members.every(m => m.game === first.game && m.mode === first.mode && m.type === first.type && Number(m.entryFee) === Number(first.entryFee));
  if(!same) return alert('All selected members must have same game, mode, type and entry fee.');

  try{
    showMsg('Pairing...');
    const res = await fetch(`${API_BASE}/match/pair`, {
      method: 'POST',
      headers: headersWithAuth(),
      body: JSON.stringify({ selectedMembers: members, game: first.game, type: first.type, mode: first.mode, entryFee: Number(first.entryFee) })
    });
    const json = await res.json();
    if(!json.success){ showMsg(json.msg || 'Pair failed', true); return; }

    const created = Array.isArray(json.data) && json.data.length ? json.data[0] : json.data;
    const newId = created?._id || created?.matchId;
    showMsg('Paired successfully. Redirecting to match details...');
    setTimeout(()=> {
      if(newId) window.location.href = `admin-match-details.html?matchId=${encodeURIComponent(newId)}`;
      else { fetchAllForTab('unpaired'); fetchAllForTab('joined'); fetchAllForTab('paired'); }
    }, 700);
  }catch(err){
    console.error(err);
    showMsg('Server error while pairing', true);
  }
}

/* ---------- Delete helpers ---------- */
/* ---------- Delete helpers ---------- */

// Delete ALL unpaired (waiting) matches
async function deleteAllUnpaired() {
  if (!confirm('Delete ALL unpaired matches?')) return;
  try {
    const res = await fetch(`${API_BASE}/match/unpaired`, {
      method: 'DELETE',
      headers: headersWithAuth()
    });
    const json = await res.json();
    showMsg(json.msg || 'Deleted unpaired matches');
    fetchAllForTab('unpaired');
  } catch (e) {
    console.error(e);
    showMsg('Error deleting', true);
  }
}

// Delete ALL paired matches (filled / ongoing / completed)
async function deleteAllPaired() {
  if (!confirm('Delete ALL paired matches?')) return;
  try {
    const res = await fetch(`${API_BASE}/match/paired`, {
      method: 'DELETE',
      headers: headersWithAuth()
    });
    const json = await res.json();
    showMsg(json.msg || 'Deleted paired matches');
    fetchAllForTab('paired');
  } catch (e) {
    console.error(e);
    showMsg('Error deleting', true);
  }
}

// Delete ALL matches (clear entire QuickMatch collection)
async function deleteAllJoined() {
  if (!confirm('Delete ALL matches? This will wipe ALL data!')) return;
  try {
    const res = await fetch(`${API_BASE}/match/all`, {
      method: 'DELETE',
      headers: headersWithAuth()
    });

    const json = await res.json();
    showMsg(json.msg || 'Deleted all matches');
    fetchAllForTab('joined');
  } catch (e) {
    console.error(e);
    showMsg('Error deleting matches', true);
  }
}

// Delete a single unpaired player (slot delete)
async function deleteSingleUnpaired(matchId, userId) {
  if (!confirm('Delete this unpaired player?')) return;
  try {
    await fetch(`${API_BASE}/match/player/${matchId}/${userId}`, {
      method: 'DELETE',
      headers: headersWithAuth()
    });
    fetchAllForTab('unpaired');
  } catch (e) {
    console.error(e);
    showMsg('Error deleting player', true);
  }
}

// Delete single paired match
async function deleteSinglePaired(matchId) {
  if (!confirm('Delete this paired match?')) return;
  try {
    await fetch(`${API_BASE}/match/${matchId}`, {
      method: 'DELETE',
      headers: headersWithAuth()
    });
    fetchAllForTab('paired');
  } catch (e) {
    console.error(e);
    showMsg('Error deleting match', true);
  }
}

// Delete a single joined player (slot delete for ALL match types)
async function deleteJoined(matchId, userId) {
  if (!confirm('Delete this player?')) return;
  try {
    await fetch(`${API_BASE}/match/player/${matchId}/${userId}`, {
      method: 'DELETE',
      headers: headersWithAuth()
    });
    fetchAllForTab('joined');
  } catch (e) {
    console.error(e);
    showMsg('Error deleting player', true);
  }
}

/* ---------- WhatsApp handlers ---------- */
function copyText(text){
  if(!text) return;
  navigator.clipboard.writeText(text).then(()=> showMsg('Copied to clipboard')).catch(()=> showMsg('Copy failed', true));
}

/* openWhatsAppForPlayer: opens wa.me link using player's phone and filled template */
function openWhatsAppForPlayer(player){
  // player expected shape: { name, uid, phone, whatsapp, matchId, game, mode, type, entryFee, team }
  const tpl = getWATemplate();
  const data = {
    name: player.name || player.uid || '',
    uid: player.uid || '',
    game: player.game || '',
    mode: player.mode || '',
    type: player.type || '',
    entryFee: player.entryFee || '',
    matchId: player.matchId || '',
    team: player.team || '',
    phone: player.phone || player.whatsapp || ''
  };
  const message = fillTemplate(tpl, data);
  const rawPhone = player.whatsapp || player.phone || '';
  const sanitized = sanitizeNumber(rawPhone);

  if(!sanitized) {
    alert('No phone available for this user');
    return;
  }

  const url = `https://wa.me/${sanitized}?text=${encodeURIComponent(message)}`;
  window.open(url, '_blank');
}

/* ---------- boot ---------- */
fetchAllForTab('joined');
</script>
</body>
</html>
