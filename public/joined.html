<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tournament Room Details</title>
<style>
  body { background:#0a0a0a; color:#fff; font-family:'Poppins',sans-serif; padding:25px; text-align:center; }
  .container { max-width:500px; margin:40px auto; background:#141414; padding:25px; border-radius:15px; box-shadow:0 0 15px #00faff50; }
  h2 { color:#00faff; margin-bottom:10px; }
  .details p { margin:6px 0; font-size:0.95rem; }
  .status { font-weight:bold; margin-top:10px; }
  .status.joined { color:#00ff88; }
  .status.notJoined { color:#ff5555; }
  .room-box { background:#1e1e1e; margin-top:15px; padding:15px; border-radius:10px; border:1px solid #00faff60; text-align:left; }
  .room-box h3 { color:#00faff; margin-bottom:10px; text-align:center; }
  #wait { background:#222; margin-top:15px; padding:12px; border-radius:8px; color:#ffcc00; }
  #joinedCount { color:#00faff; font-weight:bold; margin-top:8px; font-size:0.95rem; }
  .player-info { margin-top:15px; border:1px solid #00faff44; padding:10px; border-radius:8px; background:#111; }
  .player-info p { margin:5px 0; }
  button { background:#00faff; color:#000; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-size:15px; margin-top:10px; }
  button:hover { background:#00e0e0; }
</style>
</head>
<body>
<div class="container">
  <h2 id="tName">Loading Tournament...</h2>
  <div class="details">
    <p id="game"></p>
    <p id="date"></p>
    <p id="entry"></p>
    <p id="prize"></p>
    <p id="players"></p>
    <p id="joinedCount"></p>
    <p id="joinedStatus" class="status notJoined">‚ùå You have not joined yet.</p>
  </div>

  <div id="playerDetails" class="player-info" style="display:none;">
    <h3>Your Details</h3>
    <p><strong>Name:</strong> <span id="pName"></span></p>
    <p><strong>User ID:</strong> <span id="p_id"></span></p>
    <p><strong>Phone:</strong> <span id="pPhone"></span></p>
    <p><strong>UIDs:</strong> <span id="pUIDs"></span></p>
    <p><strong>Paid:</strong> <span id="pPaid"></span></p>
  </div>

  <div id="roomDetails" class="room-box" style="display:none;">
    <h3>Room Info</h3>
    <p><strong>ID:</strong> <span id="roomId"></span></p>
    <p><strong>Password:</strong> <span id="roomPass"></span></p>
  </div>

  <div id="wait">‚è≥ Room details will be shared before the tournament starts.</div>
  <div id="uploadSection" style="display:none;">
    <button onclick="uploadResult()">üì§ Upload Result Screenshot</button>
  </div>

  <!-- Admin-only Room Upload -->
  <div id="adminRoomSection" style="display:none; margin-top:20px;">
    <h3>Admin: Upload Room Details</h3>
    <input id="roomIdInput" placeholder="Room ID" style="padding:8px;border-radius:5px;border:none;margin:5px;">
    <input id="roomPassInput" placeholder="Room Password" style="padding:8px;border-radius:5px;border:none;margin:5px;">
    <button onclick="uploadRoomDetails()">Upload Room</button>
  </div>
</div>

<script>
const token = localStorage.getItem('token');
const params = new URLSearchParams(window.location.search);
const tournamentId = params.get('id');

const TOURNAMENT_URL = `http://localhost:5000/api/wallet/tournament/${tournamentId}`;
const RESULT_URL = `http://localhost:5000/api/wallet/uploadResult/${tournamentId}`;
const ROOM_URL = `http://localhost:5000/api/wallet/tournaments/${tournamentId}/room`;

// Correct local time parsing
function formatDateTime(tournament) {
  if (!tournament.date) return 'N/A';
  const [y,m,d] = tournament.date.split('-').map(Number);
  let hours = 0, minutes = 0;
  if(tournament.time) [hours, minutes] = tournament.time.split(':').map(Number);
  const dt = new Date(y, m-1, d, hours, minutes);
  return dt.toLocaleString([], { dateStyle:'short', timeStyle:'short' });
}

async function loadTournament() {
  try {
    const res = await fetch(TOURNAMENT_URL, { headers: { Authorization: `Bearer ${token}` } });
    const t = await res.json();
    if(!res.ok){ alert(t.msg || "Failed to load tournament"); return; }

    document.getElementById('tName').innerText = t.name;
    document.getElementById('game').innerText = `Game: ${t.game}`;
    document.getElementById('date').innerText = `Date: ${formatDateTime(t)}`;
    document.getElementById('entry').innerText = `Entry Fee: ‚Çπ${t.entryFee}`;
    document.getElementById('prize').innerText = `Prize Pool: ‚Çπ${t.prizePool}`;
    document.getElementById('players').innerText = `Max Players: ${t.maxPlayers}`;
    document.getElementById('joinedCount').innerText = `Joined Players: ${t.joinedCount || 0} / ${t.maxPlayers}`;

    // Member joined check
    if(t.joined){
      document.getElementById('joinedStatus').innerText = "‚úÖ You have joined this tournament!";
      document.getElementById('joinedStatus').classList.replace('notJoined','joined');
      const me = t.joinedUsers?.find(u => u.userId === t.userId);
      if(me){
        document.getElementById('playerDetails').style.display='block';
        document.getElementById('pName').innerText = me.name;
        document.getElementById('p_id').innerText = me.userId;
        document.getElementById('pPhone').innerText = me.phone;
        document.getElementById('pUIDs').innerText = me.gameUIDs?.join(', ') || '‚Äî';
        document.getElementById('pPaid').innerText = me.paid ? "Yes" : "No";
      }
    }

    // Room info
    if(t.roomInfo?.roomId){
      document.getElementById('roomDetails').style.display='block';
      document.getElementById('roomId').innerText = t.roomInfo.roomId;
      document.getElementById('roomPass').innerText = t.roomInfo.roomPassword;
      document.getElementById('wait').style.display='none';
      document.getElementById('uploadSection').style.display='block';
    } else {
      document.getElementById('roomDetails').style.display='none';
      document.getElementById('wait').style.display='block';
      document.getElementById('uploadSection').style.display='none';
    }

    if(t.isAdmin) document.getElementById('adminRoomSection').style.display='block';

  } catch(err){ console.error("Error:",err); }
}

async function uploadResult() {
  const input = document.createElement('input'); 
  input.type='file'; 
  input.accept='image/*';
  input.onchange = async () => { 
    if(!input.files[0]) return;
    const formData = new FormData(); 
    formData.append('screenshot', input.files[0]);
    try{
      const res = await fetch(RESULT_URL, { method:'POST', headers:{Authorization: `Bearer ${token}`}, body: formData });
      const data = await res.json();
      alert(data.msg || (res.ok?"‚úÖ Screenshot uploaded!":"‚ùå Upload failed"));
    }catch(err){ console.error(err); alert("Result upload failed."); }
  };
  input.click();
}

async function uploadRoomDetails() {
  const roomId = document.getElementById('roomIdInput').value.trim();
  const roomPassword = document.getElementById('roomPassInput').value.trim();
  if(!roomId || !roomPassword){ alert("Fill both fields"); return; }
  try{
    const res = await fetch(ROOM_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json', Authorization:`Bearer ${token}`},
      body:JSON.stringify({roomId,roomPassword})
    });
    const data = await res.json();
    alert(data.msg || (res.ok?"‚úÖ Room uploaded!":"‚ùå Failed"));
    loadTournament();
  }catch(err){ console.error(err); }
}

loadTournament();
setInterval(loadTournament,5000);
</script>
</body>
</html>
