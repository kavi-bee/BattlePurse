<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Neon Auth Page</title>
  <style>
    * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
    body {
      margin: 0;
      overflow: hidden;
      height: 100vh;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    canvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: -3;
    }
    .container {
      position: relative;
      width: 420px;
      padding: 40px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 20px;
      overflow: hidden;
      z-index: 1;
    }
    .container::before {
      content: "";
      position: absolute;
      top: -2px; left: -2px; right: -2px; bottom: -2px;
      background: linear-gradient(45deg, #ae00ff, #00faff, #ff007c, #ae00ff);
      background-size: 400% 400%;
      animation: borderGlow 6s linear infinite;
      z-index: -1;
      filter: blur(5px);
      border-radius: 20px;
    }
    @keyframes borderGlow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .toggle {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
    }
    .toggle button {
      width: 48%;
      padding: 10px;
      background: transparent;
      border: 2px solid #ae00ff;
      color: #ae00ff;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.3s;
    }
    .toggle button.active,
    .toggle button:hover {
      background: #ae00ff;
      color: #000;
    }
    form {
      display: none;
      flex-direction: column;
    }
    form.active {
      display: flex;
    }
    form h2 {
      color: #ae00ff;
      text-align: center;
      margin-bottom: 20px;
    }
    input {
      padding: 12px;
      margin: 10px 0;
      border: none;
      border-radius: 8px;
      background: #111;
      color: #ae00ff;
      outline: none;
      box-shadow: 0 0 10px #ae00ff inset;
    }
    button.submit {
      margin-top: 20px;
      padding: 12px;
      background: #ae00ff;
      border: none;
      color: #000;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 0 15px #ae00ff;
      transition: 0.2s;
    }
    button.submit:hover {
      background: #00faff;
      box-shadow: 0 0 20px #00faff;
    }
    button#forgetBtn {
      margin-top:10px;
      background:transparent;
      color:#ae00ff;
      border:none;
      cursor:pointer;
    }
    .glow {
      position: absolute;
      top: -40px;
      left: -40px;
      width: 120px;
      height: 120px;
      background: #ae00ff;
      border-radius: 50%;
      filter: blur(70px);
      opacity: 0.3;
      animation: float 6s ease-in-out infinite;
      z-index: -2;
    }
    @keyframes float {
      0% { transform: translate(0, 0); }
      50% { transform: translate(40px, 30px); }
      100% { transform: translate(0, 0); }
    }
  </style>
</head>
<body>

<canvas id="stars"></canvas>

<div class="container">
  <div class="glow"></div>
  <div class="toggle">
    <button id="loginBtn" class="active">Login</button>
    <button id="registerBtn">Register</button>
  </div>

  <!-- LOGIN FORM -->
  <form id="loginForm" class="active">
    <h2>Login</h2>
    <input type="text" id="loginMobile" placeholder="Mobile Number" required />
    <input type="password" id="loginPassword" placeholder="Password" required />
    <button type="submit" class="submit">Login</button>
    <button type="button" id="forgetBtn">Forgot Password?</button>
  </form>

  <!-- REGISTER FORM -->
  <form id="registerForm">
    <h2>Register</h2>
    <input type="text" id="regName" placeholder="Full Name" required />
    <input type="text" id="regMobile" placeholder="Mobile Number" required />
    <input type="password" id="regPassword" placeholder="Password" required />
    <button type="submit" class="submit">Register</button>
  </form>

  <!-- RETURNING USER LOGIN -->
  <form id="returningForm">
    <h2>Welcome Back!</h2>
    <p style="color:#ae00ff; text-align:center;">Login with K-CODE or Fingerprint</p>
    <input type="password" id="kcodeInput" placeholder="Enter K-CODE" />
    <button type="button" id="kcodeBtn" class="submit">Login with K-CODE</button>
    <button type="button" id="fingerprintBtn" class="submit">Login with Fingerprint</button>
  </form>
</div>

<audio id="clickSound" src="https://www.fesliyanstudios.com/play-mp3/387" preload="auto"></audio>

<script>
  const loginBtn = document.getElementById('loginBtn');
  const registerBtn = document.getElementById('registerBtn');
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  const returningForm = document.getElementById('returningForm');
  const clickSound = document.getElementById('clickSound');

  const API_URL = "http://localhost:5000/api/wallet";

  // Show returning user form if K-CODE exists
  window.addEventListener("DOMContentLoaded", () => {
    const token = localStorage.getItem("token");
    const hasKcode = localStorage.getItem("hasKcode");
    if(token && hasKcode === "true") {
      loginForm.style.display = "none";
      registerForm.style.display = "none";
      returningForm.style.display = "flex";
    }
  });

  // Toggle forms
  loginBtn.onclick = () => {
    clickSound.play();
    loginForm.classList.add('active');
    registerForm.classList.remove('active');
    returningForm.style.display = "none";
    loginBtn.classList.add('active');
    registerBtn.classList.remove('active');
  };
  registerBtn.onclick = () => {
    clickSound.play();
    registerForm.classList.add('active');
    loginForm.classList.remove('active');
    returningForm.style.display = "none";
    registerBtn.classList.add('active');
    loginBtn.classList.remove('active');
  };

  // Register
  document.getElementById("registerForm").onsubmit = async function(e) {
    e.preventDefault();
    const name = document.getElementById("regName").value.trim();
    const phone = document.getElementById("regMobile").value.trim();
    const password = document.getElementById("regPassword").value.trim();
    if (!name || !phone || !password) { alert("Please fill all fields!"); return; }
    try {
      const res = await fetch(`${API_URL}/register`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, phone, password })
      });
      const data = await res.json();
      alert(data.msg || "Registered successfully");
    } catch(err){ alert("Error connecting to server!"); console.error(err); }
  };

  // Login
  document.getElementById("loginForm").onsubmit = async function(e) {
    e.preventDefault();
    const phone = document.getElementById("loginMobile").value.trim();
    const password = document.getElementById("loginPassword").value.trim();
    if (!phone || !password) { alert("Please enter both mobile and password!"); return; }
    try {
      const res = await fetch(`${API_URL}/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ phone, password })
      });
      const data = await res.json();
      if(res.ok && data.token){
        localStorage.setItem("token", data.token);
        localStorage.setItem("userName", data.user?.name || "");
        localStorage.setItem("hasKcode", "true"); // User can now use K-CODE next time
        alert("Login successful!");
        window.location.href = "gamezone.html";
      } else { alert(data.msg || "Login failed"); }
    } catch(err){ alert("Error connecting to server!"); console.error(err); }
  };

  // Forget Password
  document.getElementById("forgetBtn").onclick = async function () {
    const phone = prompt("Enter your registered mobile number:");
    if(!phone) return;
    try {
      const checkRes = await fetch(`${API_URL}/forgot/check`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ phone })
      });
      const checkData = await checkRes.json();
      if(!checkData.success){ alert(checkData.msg || "Phone not found!"); return; }
      const newPassword = prompt("Enter your new password:");
      if(!newPassword) return;
      const resetRes = await fetch(`${API_URL}/forgot/reset`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ phone, newPassword })
      });
      const resetData = await resetRes.json();
      if(resetData.success){
        alert(resetData.msg || "Password reset successfully!");
        document.getElementById("loginMobile").value = phone;
        document.getElementById("loginPassword").value = newPassword;
      } else { alert(resetData.msg || "Password reset failed!"); }
    } catch(err){ console.error(err); alert("Error connecting to server!"); }
  };

  // K-CODE login
  document.getElementById("kcodeBtn").onclick = async () => {
    const kcode = document.getElementById("kcodeInput").value.trim();
    if(!kcode){ alert("Enter your K-CODE!"); return; }
    try {
      const res = await fetch(`${API_URL}/login/kcode`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ kcode })
      });
      const data = await res.json();
      if(data.success && data.token){
        localStorage.setItem("token", data.token);
        alert("Login successful!");
        window.location.href = "gamezone.html";
      } else { alert(data.msg || "Wrong K-CODE"); }
    } catch(err){ console.error(err); alert("Error connecting to server!"); }
  };

  // Fingerprint login
  document.getElementById("fingerprintBtn").onclick = async () => {
    if(!window.PublicKeyCredential){ alert("Fingerprint login not supported."); return; }
    try {
      const challengeRes = await fetch(`${API_URL}/biometric/challenge`, { method: "POST", headers: {"Content-Type":"application/json"}});
      const challengeData = await challengeRes.json();
      const challenge = new Uint8Array(challengeData.challenge);
      const credential = await navigator.credentials.get({
        publicKey: {
          challenge: challenge,
          allowCredentials: challengeData.allowCredentials,
          timeout: 60000,
          userVerification: "preferred"
        }
      });
      const verifyRes = await fetch(`${API_URL}/biometric/verify`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ credential })
      });
      const verifyData = await verifyRes.json();
      if(verifyData.success){
        localStorage.setItem("token", verifyData.token);
        alert("Fingerprint login successful!");
        window.location.href = "gamezone.html";
      } else { alert(verifyData.msg || "Fingerprint login failed."); }
    } catch(err){ console.error(err); alert("Fingerprint login error."); }
  };

  // Neon Star Background
  const canvas = document.getElementById("stars");
  const ctx = canvas.getContext("2d");
  let stars = [];
  function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; createStars(); }
  function createStars() { stars = []; for(let i=0;i<150;i++){ stars.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, radius:Math.random()*1.5+0.5, alpha:Math.random(), speed:Math.random()*0.5+0.2}); } }
  function drawStars() { ctx.clearRect(0,0,canvas.width,canvas.height); for(const s of stars){ ctx.beginPath(); ctx.arc(s.x,s.y,s.radius,0,2*Math.PI); ctx.fillStyle=`rgba(255,0,255,${s.alpha})`; ctx.fill(); s.y+=s.speed; if(s.y>canvas.height)s.y=0; } requestAnimationFrame(drawStars); }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas(); drawStars();

</script>
</body>
</html>
